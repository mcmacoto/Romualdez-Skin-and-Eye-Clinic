{% extends "bookings_v2/base_v2.html" %}
{% load static %}

{% block title %}Admin Dashboard - Romualdez Skin & Eye Clinic{% endblock %}

{% block extra_css %}
<!-- Cropper.js CSS -->
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/cropperjs/1.6.1/cropper.min.css">

<style>
    /* Override global background image */
    body,
    body::before,
    body::after {
        background: #f8f9fa !important;
        background-image: none !important;
        background-attachment: initial !important;
    }
    
    html {
        background: #f8f9fa !important;
    }
    
    .dashboard-container {
        padding: 2rem 0;
    }
    
    .dashboard-header {
        background: linear-gradient(135deg, #3d5c3d 0%, #2e472e 100%) !important;
        color: white !important;
        padding: 2rem;
        border-radius: 12px;
        margin-bottom: 2rem;
        box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
    }
    
    .dashboard-header h1 {
        margin: 0 0 0.5rem 0;
        font-size: 2rem;
        font-weight: 600;
        color: white !important;
        text-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
    }
    
    .dashboard-header p {
        margin: 0;
        opacity: 0.95;
        color: rgba(255, 255, 255, 0.95) !important;
    }
    
    .permission-notice {
        padding: 1rem;
        border-radius: 8px;
        margin-bottom: 2rem;
        display: flex;
        align-items: center;
        gap: 1rem;
    }
    
    .permission-notice.superuser {
        background: linear-gradient(135deg, #4a7c59 0%, #3d5c3d 100%);
        color: white;
    }
    
    .permission-notice.staff {
        background: linear-gradient(135deg, #0dcaf0 0%, #0891b2 100%);
        color: white;
    }
    
    .permission-notice i {
        font-size: 1.5rem;
    }
    
    .section-title {
        font-size: 1.5rem;
        font-weight: 600;
        color: var(--primary-color);
        margin-bottom: 1.5rem;
        display: flex;
        align-items: center;
        gap: 0.5rem;
    }
    
    .section-title i {
        color: var(--primary-color);
    }
    
    /* Stats Grid */
    .stats-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
        gap: 1.5rem;
        margin-bottom: 2rem;
    }
    
    .stat-card {
        background: white;
        border-radius: 12px;
        padding: 1.5rem;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.08);
        transition: all 0.3s ease;
        cursor: pointer;
        position: relative;
        overflow: hidden;
    }
    
    .stat-card::before {
        content: '';
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        height: 4px;
        background: linear-gradient(135deg, var(--primary-color) 0%, var(--dark-green) 100%);
        transform: scaleX(0);
        transform-origin: left;
        transition: transform 0.3s ease;
    }
    
    .stat-card:hover {
        transform: translateY(-5px);
        box-shadow: 0 8px 20px rgba(0, 0, 0, 0.15);
    }
    
    .stat-card:hover::before {
        transform: scaleX(1);
    }
    
    .stat-card.warning {
        border-left: 4px solid #ffc107;
    }
    
    .stat-card.danger {
        border-left: 4px solid #dc3545;
    }
    
    .stat-icon {
        width: 50px;
        height: 50px;
        border-radius: 12px;
        display: flex;
        align-items: center;
        justify-content: center;
        margin-bottom: 1rem;
        font-size: 1.5rem;
        background: linear-gradient(135deg, var(--primary-color) 0%, var(--dark-green) 100%);
        color: white;
    }
    
    .stat-card.warning .stat-icon {
        background: linear-gradient(135deg, #ffc107 0%, #ffca2c 100%);
    }
    
    .stat-card.danger .stat-icon {
        background: linear-gradient(135deg, #dc3545 0%, #c82333 100%);
    }
    
    .stat-number {
        font-size: 2rem;
        font-weight: 700;
        color: var(--primary-color);
        margin-bottom: 0.5rem;
    }
    
    .stat-label {
        font-size: 0.95rem;
        color: #6c757d;
        margin-bottom: 0.5rem;
    }
    
    .stat-hint {
        font-size: 0.85rem;
        color: #adb5bd;
        font-style: italic;
    }
    
    /* Financial Cards */
    .financial-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
        gap: 1.5rem;
        margin-bottom: 2rem;
    }
    
    .financial-card {
        background: white;
        border-radius: 12px;
        padding: 1.5rem;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.08);
        display: flex;
        align-items: center;
        gap: 1.5rem;
    }
    
    .financial-card.revenue {
        background: linear-gradient(135deg, #28a745 0%, #34ce57 100%);
        color: white;
    }
    
    .financial-card.balance {
        background: linear-gradient(135deg, #ffc107 0%, #ffca2c 100%);
        color: white;
    }
    
    .financial-card.billed {
        background: linear-gradient(135deg, #17a2b8 0%, #20c997 100%);
        color: white;
    }
    
    .financial-icon {
        width: 60px;
        height: 60px;
        background: rgba(255, 255, 255, 0.2);
        border-radius: 12px;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 1.8rem;
    }
    
    .financial-content {
        flex: 1;
    }
    
    .financial-label {
        font-size: 0.9rem;
        opacity: 0.9;
        margin-bottom: 0.5rem;
    }
    
    .financial-value {
        font-size: 1.8rem;
        font-weight: 700;
    }
    
    /* Quick Actions */
    .quick-actions-grid {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(180px, 1fr));
        gap: 1rem;
    }
    
    .quick-action-btn {
        background: white;
        border: 2px solid #e9ecef;
        border-radius: 12px;
        padding: 1.5rem 1rem;
        text-align: center;
        text-decoration: none;
        color: var(--primary-color);
        transition: all 0.3s ease;
        display: flex;
        flex-direction: column;
        align-items: center;
        gap: 0.75rem;
    }
    
    .quick-action-btn:hover {
        background: linear-gradient(135deg, var(--primary-color) 0%, var(--primary-dark) 100%);
        color: white;
        border-color: var(--primary-color);
        transform: translateY(-3px);
        box-shadow: 0 5px 15px rgba(61, 92, 61, 0.3);
    }
    
    .quick-action-btn i {
        font-size: 2rem;
    }
    
    .quick-action-btn span {
        font-size: 0.9rem;
        font-weight: 500;
    }
    
    /* Modal Styles */
    .modal-header {
        background: white;  /* White background for readability */
        color: #212529;  /* Dark text */
        border-bottom: 3px solid var(--primary-color);  /* Colored border instead */
        border-radius: 0;
    }
    
    .modal-title {
        color: #212529 !important;  /* Dark color for visibility */
        font-weight: 600;
    }
    
    /* Special styling for modals with specifically colored headers */
    .modal-header.bg-success {
        background: linear-gradient(135deg, #28a745 0%, #34ce57 100%) !important;
        color: white !important;
        border-bottom: none;
    }
    
    .modal-header.bg-success .modal-title {
        color: white !important;
    }
    
    .modal-header .btn-close {
        opacity: 1 !important;
        background-color: #dc3545 !important;  /* Red background */
        border-radius: 50% !important;
        width: 32px !important;
        height: 32px !important;
        padding: 0 !important;
        filter: none !important;  /* Remove any filters from external CSS */
        background-image: url("data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 16 16' fill='%23fff'%3e%3cpath d='M.293.293a1 1 0 011.414 0L8 6.586 14.293.293a1 1 0 111.414 1.414L9.414 8l6.293 6.293a1 1 0 01-1.414 1.414L8 9.414l-6.293 6.293a1 1 0 01-1.414-1.414L6.586 8 .293 1.707a1 1 0 010-1.414z'/%3e%3c/svg%3e") !important;
        background-size: 16px !important;
        background-position: center !important;
        background-repeat: no-repeat !important;
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.3) !important;
        transition: all 0.2s ease !important;
        position: relative !important;
    }
    
    .modal-header .btn-close::before,
    .modal-header .btn-close::after {
        display: none !important;  /* Remove custom X since we're using SVG */
    }
    
    .modal-header .btn-close:hover {
        background-color: #bb2d3b !important;  /* Darker red on hover */
        transform: scale(1.1) !important;
    }
    
    .modal-header.bg-success .btn-close {
        background-color: #ffc107 !important;  /* Yellow/warning color for green headers */
    }
    
    .modal-header.bg-success .btn-close:hover {
        background-color: #ffb300 !important;
    }
    
    /* Ensure btn-close-white is also styled for POS modal */
    .btn-close-white {
        background-color: #ffc107 !important;  /* Yellow for visibility on green */
        opacity: 1 !important;
        filter: none !important;
        background-image: url("data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 16 16' fill='%23000'%3e%3cpath d='M.293.293a1 1 0 011.414 0L8 6.586 14.293.293a1 1 0 111.414 1.414L9.414 8l6.293 6.293a1 1 0 01-1.414 1.414L8 9.414l-6.293 6.293a1 1 0 01-1.414-1.414L6.586 8 .293 1.707a1 1 0 010-1.414z'/%3e%3c/svg%3e") !important;
        background-size: 16px !important;
        background-position: center !important;
        border-radius: 50% !important;
        width: 32px !important;
        height: 32px !important;
    }
    
    .btn-close-white:hover {
        background-color: #ffb300 !important;
    }
    
    /* Back and Cancel Button Styling */
    .btn-outline-secondary,
    .btn-secondary {
        background-color: #6c757d !important;
        color: white !important;
        border: 2px solid #5a6268 !important;
        font-weight: 500;
    }
    
    .btn-outline-secondary:hover,
    .btn-secondary:hover {
        background-color: #5a6268 !important;
        color: white !important;
        border-color: #545b62 !important;
        transform: translateY(-1px);
        box-shadow: 0 2px 4px rgba(0,0,0,0.2);
    }
    
    .btn-outline-secondary i,
    .btn-secondary i {
        color: white !important;
    }
    
    .modal-body {
        max-height: 70vh;
        overflow-y: auto;
    }
    
    /* Loading State */
    .loading-state {
        text-align: center;
        padding: 3rem;
        color: #6c757d;
    }
    
    .loading-state .spinner-border {
        width: 3rem;
        height: 3rem;
        border-width: 0.25rem;
        margin-bottom: 1rem;
    }
    
    /* Empty State */
    .empty-state {
        text-align: center;
        padding: 3rem;
        color: #6c757d;
    }
    
    .empty-state i {
        font-size: 4rem;
        color: #dee2e6;
        margin-bottom: 1rem;
    }
    
    .empty-state h3 {
        color: #495057;
        margin-bottom: 0.5rem;
    }
    
    /* Transaction Summary */
    .transaction-summary {
        margin-top: 1.5rem;
        padding-top: 1.5rem;
        border-top: 2px solid #e9ecef;
    }
    
    .summary-grid {
        display: grid;
        grid-template-columns: repeat(2, 1fr);
        gap: 0.75rem;
        margin-top: 0.75rem;
    }
    
    .summary-item {
        background: #fff;
        border: 1px solid #e9ecef;
        border-radius: 8px;
        padding: 1rem;
        display: flex;
        align-items: center;
        gap: 0.75rem;
        transition: all 0.2s ease;
    }
    
    .summary-item.clickable {
        cursor: pointer;
    }
    
    .summary-item.clickable:hover {
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
        transform: translateY(-2px);
        border-color: var(--primary-color);
    }
    
    .summary-icon {
        width: 40px;
        height: 40px;
        display: flex;
        align-items: center;
        justify-content: center;
        border-radius: 50%;
        font-size: 1.25rem;
    }
    
    .summary-icon.paid {
        background: rgba(40, 167, 69, 0.1);
        color: #28a745;
    }
    
    .summary-icon.unpaid {
        background: rgba(220, 53, 69, 0.1);
        color: #dc3545;
    }
    
    .summary-icon.total {
        background: rgba(108, 117, 125, 0.1);
        color: #6c757d;
    }
    
    .summary-details {
        flex: 1;
    }
    
    .summary-count {
        font-size: 1.5rem;
        font-weight: 700;
        color: #212529;
        line-height: 1;
    }
    
    .summary-label {
        font-size: 0.75rem;
        color: #6c757d;
        margin-top: 0.25rem;
    }

    @media (max-width: 768px) {
        .stats-grid {
            grid-template-columns: 1fr;
        }
        
        .financial-grid {
            grid-template-columns: 1fr;
        }
        
        .quick-actions-grid {
            grid-template-columns: repeat(2, 1fr);
        }
        
        .summary-grid {
            grid-template-columns: 1fr;
        }
    }
    
    /* ===== TOAST NOTIFICATIONS ===== */
    .toast-notification {
        min-width: 300px;
        max-width: 400px;
        background: white;
        border-radius: 8px;
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
        margin-bottom: 10px;
        padding: 16px;
        display: flex;
        align-items: center;
        gap: 12px;
        animation: slideInRight 0.3s ease, fadeIn 0.3s ease;
        border-left: 4px solid #28a745;
    }
    
    .toast-notification.toast-success {
        border-left-color: #28a745;
    }
    
    .toast-notification.toast-error {
        border-left-color: #dc3545;
    }
    
    .toast-notification.toast-warning {
        border-left-color: #ffc107;
    }
    
    .toast-notification.toast-info {
        border-left-color: #17a2b8;
    }
    
    .toast-icon {
        font-size: 24px;
        flex-shrink: 0;
    }
    
    .toast-success .toast-icon {
        color: #28a745;
    }
    
    .toast-error .toast-icon {
        color: #dc3545;
    }
    
    .toast-warning .toast-icon {
        color: #ffc107;
    }
    
    .toast-info .toast-icon {
        color: #17a2b8;
    }
    
    .toast-content {
        flex: 1;
    }
    
    .toast-title {
        font-weight: 600;
        font-size: 14px;
        margin-bottom: 4px;
        color: #212529;
    }
    
    .toast-message {
        font-size: 13px;
        color: #6c757d;
        margin: 0;
    }
    
    .toast-close {
        background: none;
        border: none;
        font-size: 20px;
        color: #6c757d;
        cursor: pointer;
        padding: 0;
        width: 24px;
        height: 24px;
        display: flex;
        align-items: center;
        justify-content: center;
        border-radius: 4px;
        transition: background-color 0.2s;
    }
    
    .toast-close:hover {
        background-color: rgba(0, 0, 0, 0.05);
    }
    
    @keyframes slideInRight {
        from {
            transform: translateX(100%);
            opacity: 0;
        }
        to {
            transform: translateX(0);
            opacity: 1;
        }
    }
    
    @keyframes fadeIn {
        from { opacity: 0; }
        to { opacity: 1; }
    }
    
    @keyframes fadeOut {
        from { opacity: 1; }
        to { opacity: 0; }
    }
</style>
{% endblock %}

{% block content %}
<!-- Toast Notification Container -->
<div id="toastContainer" style="position: fixed; top: 20px; right: 20px; z-index: 9999;"></div>

<div class="container dashboard-container">
    <!-- Dashboard Header -->
    <div class="dashboard-header">
        <h1>
            <i class="fas fa-tachometer-alt"></i>
            Welcome, {{ user.get_full_name|default:user.username }}
        </h1>
        <p>Here's an overview of your clinic operations</p>
    </div>
    
    <!-- Permission Notice -->
    {% if user.is_superuser %}
    <div class="permission-notice superuser">
        <i class="fas fa-crown"></i>
        <div>
            <strong>Superuser Access</strong>
            <p class="mb-0">You have full administrative privileges</p>
        </div>
    </div>
    {% elif user.is_staff %}
    <div class="permission-notice staff">
        <i class="fas fa-user-shield"></i>
        <div>
            <strong>Staff Access</strong>
            <p class="mb-0">You have staff-level permissions</p>
        </div>
    </div>
    {% endif %}
    
    <div class="row">
        <!-- LEFT COLUMN: Statistics -->
        <div class="col-lg-8">
            <h3 class="section-title">
                <i class="fas fa-chart-line"></i>
                Key Statistics
            </h3>
            
            <!-- Auto-refreshable stats grid container -->
            <div id="dashboard-stats-container" 
                 hx-get="{% url 'bookings_v2:htmx_dashboard_stats' %}" 
                 hx-trigger="refreshStats from:body"
                 hx-swap="innerHTML"
                 hx-indicator="#stats-loading">
                {% include 'bookings_v2/htmx_partials/dashboard_stats.html' %}
            </div>
            
            <!-- Loading indicator -->
            <div id="stats-loading" class="htmx-indicator" style="display: none;">
                <div class="text-center py-3">
                    <div class="spinner-border text-primary" role="status">
                        <span class="visually-hidden">Loading...</span>
                    </div>
                    <p class="text-muted mt-2">Updating statistics...</p>
                </div>
            </div>
            
            <!-- Auto-refreshable financial overview container -->
            <div id="financial-overview-container" 
                 hx-get="{% url 'bookings_v2:htmx_financial_overview' %}" 
                 hx-trigger="refreshFinancials from:body"
                 hx-swap="innerHTML"
                 hx-indicator="#financial-loading">
                {% include 'bookings_v2/htmx_partials/financial_overview.html' %}
            </div>
            
            <!-- Loading indicator for financial stats -->
            <div id="financial-loading" class="htmx-indicator" style="display: none;">
                <div class="text-center py-3">
                    <div class="spinner-border text-success" role="status">
                        <span class="visually-hidden">Loading...</span>
                    </div>
                    <p class="text-muted mt-2">Updating financial data...</p>
                </div>
            </div>
        </div>
        
        <!-- RIGHT COLUMN: Quick Actions -->
        <div class="col-lg-4">
            <h3 class="section-title">
                <i class="fas fa-bolt"></i>
                Quick Actions
            </h3>
            
            <div class="quick-actions-grid">
                <!-- User Management -->
                <button type="button" class="quick-action-btn" 
                        hx-get="{% url 'bookings_v2:htmx_users_list' %}" 
                        hx-target="#usersListContainer"
                        data-bs-toggle="modal" 
                        data-bs-target="#usersModal">
                    <i class="fas fa-users"></i>
                    <span>Manage Users</span>
                </button>
                
                <button type="button" class="quick-action-btn" 
                        hx-get="{% url 'bookings_v2:htmx_user_create_form' %}" 
                        hx-target="#userEditModalBody"
                        data-bs-toggle="modal" 
                        data-bs-target="#userEditModal">
                    <i class="fas fa-user-plus"></i>
                    <span>Create User</span>
                </button>
                
                <!-- Booking Management - GROUPED -->
                <a href="{% url 'bookings_v2:booking' %}" class="quick-action-btn">
                    <i class="fas fa-plus"></i>
                    <span>New Booking</span>
                </a>
                
                <button type="button" class="quick-action-btn" 
                        hx-get="{% url 'bookings_v2:htmx_pending_bookings' %}" 
                        hx-target="#pendingBookingsContainer"
                        data-bs-toggle="modal" 
                        data-bs-target="#pendingBookingsModal">
                    <i class="fas fa-clock"></i>
                    <span>Pending Bookings</span>
                </button>
                
                <!-- Patient Management - GROUPED -->
                <button type="button" class="quick-action-btn"
                        hx-get="{% url 'bookings_v2:htmx_patients_list' %}" 
                        hx-target="#patientsModalBody"
                        data-bs-toggle="modal" 
                        data-bs-target="#patientsModal">
                    <i class="fas fa-clipboard-list"></i>
                    <span>Patient Profiles</span>
                </button>
                
                <button type="button" class="quick-action-btn"
                        hx-get="{% url 'bookings_v2:htmx_patient_create_form' %}" 
                        hx-target="#patientsModalBody"
                        data-bs-toggle="modal" 
                        data-bs-target="#patientsModal">
                    <i class="fas fa-user-md"></i>
                    <span>New Patient</span>
                </button>
                
                <!-- Medical Records - GROUPED -->
                <button type="button" class="quick-action-btn"
                        hx-get="{% url 'bookings_v2:htmx_medical_records_list' %}" 
                        hx-target="#medicalRecordsModalBody"
                        data-bs-toggle="modal" 
                        data-bs-target="#medicalRecordsModal">
                    <i class="fas fa-notes-medical"></i>
                    <span>Medical Records</span>
                </button>
                
                <button type="button" class="quick-action-btn"
                        hx-get="{% url 'bookings_v2:htmx_medical_record_create_form' %}" 
                        hx-target="#medicalRecordsModalBody"
                        data-bs-toggle="modal" 
                        data-bs-target="#medicalRecordsModal">
                    <i class="fas fa-file-medical-alt"></i>
                    <span>New Record</span>
                </button>
                
                <!-- Appointments -->
                <button type="button" class="quick-action-btn"
                        hx-get="{% url 'bookings_v2:htmx_appointments_list' %}" 
                        hx-target="#appointmentsModalBody"
                        data-bs-toggle="modal" 
                        data-bs-target="#appointmentsModal">
                    <i class="fas fa-calendar-plus"></i>
                    <span>View Appointments</span>
                </button>
                
                <button type="button" class="quick-action-btn"
                        hx-get="{% url 'bookings_v2:htmx_appointment_create_form' %}" 
                        hx-target="#appointmentsModalBody"
                        data-bs-toggle="modal" 
                        data-bs-target="#appointmentsModal">
                    <i class="fas fa-calendar-plus"></i>
                    <span>New Appointment</span>
                </button>
                
                <!-- Services Management - GROUPED -->
                <button type="button" class="quick-action-btn"
                        hx-get="{% url 'bookings_v2:htmx_services_list' %}" 
                        hx-target="#servicesModalBody"
                        data-bs-toggle="modal" 
                        data-bs-target="#servicesModal">
                    <i class="fas fa-concierge-bell"></i>
                    <span>Manage Services</span>
                </button>
                
                <button type="button" class="quick-action-btn"
                        hx-get="{% url 'bookings_v2:htmx_service_create_form' %}" 
                        hx-target="#servicesModalBody"
                        data-bs-toggle="modal" 
                        data-bs-target="#servicesModal">
                    <i class="fas fa-plus-circle"></i>
                    <span>New Service</span>
                </button>
                
                <!-- Inventory Management - GROUPED -->
                <button type="button" class="quick-action-btn"
                        hx-get="{% url 'bookings_v2:htmx_inventory_list' %}" 
                        hx-target="#inventoryModalBody"
                        data-bs-toggle="modal" 
                        data-bs-target="#inventoryModal">
                    <i class="fas fa-boxes"></i>
                    <span>View Inventory</span>
                </button>
                
                <button type="button" class="quick-action-btn"
                        hx-get="{% url 'bookings_v2:htmx_inventory_create_form' %}" 
                        hx-target="#inventoryModalBody"
                        data-bs-toggle="modal" 
                        data-bs-target="#inventoryModal">
                    <i class="fas fa-box"></i>
                    <span>Add Inventory</span>
                </button>
                
                <!-- Billing -->
                <button type="button" class="quick-action-btn"
                        hx-get="{% url 'bookings_v2:htmx_all_billings' %}" 
                        hx-target="#billingsModalBody"
                        data-bs-toggle="modal" 
                        data-bs-target="#billingsModal">
                    <i class="fas fa-file-invoice-dollar"></i>
                    <span>All Bills</span>
                </button>
                
                <button type="button" class="quick-action-btn"
                        hx-get="{% url 'bookings_v2:htmx_payment_create_form' %}" 
                        hx-target="#billingsModalBody"
                        data-bs-toggle="modal" 
                        data-bs-target="#billingsModal">
                    <i class="fas fa-money-bill-wave"></i>
                    <span>Record Payment</span>
                </button>
                
                <!-- Point of Sale -->
                <button type="button" class="quick-action-btn"
                        hx-get="{% url 'bookings_v2:htmx_pos_interface' %}" 
                        hx-target="#posModalBody"
                        data-bs-toggle="modal" 
                        data-bs-target="#posModal">
                    <i class="fas fa-cash-register"></i>
                    <span>Point of Sale</span>
                </button>
                
                <button type="button" class="quick-action-btn"
                        hx-get="{% url 'bookings_v2:htmx_pos_sales_list' %}" 
                        hx-target="#posModalBody"
                        data-bs-toggle="modal" 
                        data-bs-target="#posModal">
                    <i class="fas fa-receipt"></i>
                    <span>View All Sales</span>
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Analytics Charts Section -->
<div class="row mt-4">
    <div class="col-12">
        {% include 'bookings_v2/partials/dashboard_charts.html' %}
    </div>
</div>

<!-- Appointments Modal -->
<div class="modal fade" id="appointmentsModal" tabindex="-1" aria-labelledby="appointmentsModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-xl">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="appointmentsModalLabel">
                    <i class="fas fa-calendar-check"></i>
                    Appointments
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body" id="appointmentsModalBody">
                <div class="loading-state">
                    <div class="spinner-border text-primary" role="status">
                        <span class="visually-hidden">Loading...</span>
                    </div>
                    <p>Loading appointments...</p>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Patients Modal -->
<div class="modal fade" id="patientsModal" tabindex="-1" aria-labelledby="patientsModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-xl">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="patientsModalLabel">
                    <i class="fas fa-users"></i>
                    Patient Profiles
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body" id="patientsModalBody">
                <!-- Content loaded via HTMX -->
            </div>
        </div>
    </div>
</div>

<!-- Medical Records Modal -->
<div class="modal fade" id="medicalRecordsModal" tabindex="-1" aria-labelledby="medicalRecordsModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-xl">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="medicalRecordsModalLabel">
                    <i class="fas fa-file-medical"></i>
                    Medical Records
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body" id="medicalRecordsModalBody">
                <div class="loading-state">
                    <div class="spinner-border text-primary" role="status">
                        <span class="visually-hidden">Loading...</span>
                    </div>
                    <p>Loading medical records...</p>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Services Modal -->
<div class="modal fade" id="servicesModal" tabindex="-1" aria-labelledby="servicesModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-xl">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="servicesModalLabel">
                    <i class="fas fa-cogs"></i>
                    Services Management
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body" id="servicesModalBody">
                <div class="d-flex justify-content-end mb-3">
                    <button type="button" 
                            class="btn btn-primary"
                            hx-get="{% url 'bookings_v2:htmx_service_create_form' %}"
                            hx-target="#servicesModalBody"
                            hx-swap="innerHTML">
                        <i class="fas fa-plus"></i> Add Service
                    </button>
                </div>
                <div class="loading-state">
                    <div class="spinner-border text-primary" role="status">
                        <span class="visually-hidden">Loading...</span>
                    </div>
                    <p>Loading services...</p>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Inventory Modal -->
<div class="modal fade" id="inventoryModal" tabindex="-1" aria-labelledby="inventoryModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-xl">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="inventoryModalLabel">
                    <i class="fas fa-boxes"></i>
                    Inventory Management
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body" id="inventoryModalBody">
                <div class="loading-state">
                    <div class="spinner-border text-primary" role="status">
                        <span class="visually-hidden">Loading...</span>
                    </div>
                    <p>Loading inventory...</p>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Inventory Adjust Stock Modal -->
<div class="modal fade" id="inventoryAdjustModal" tabindex="-1" aria-labelledby="inventoryAdjustModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="inventoryAdjustModalLabel">
                    <i class="fas fa-plus-minus"></i>
                    Adjust Stock
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body" id="inventoryAdjustModalBody">
                <!-- Content loaded via HTMX -->
            </div>
        </div>
    </div>
</div>

<!-- POS (Point of Sale) Modal -->
<div class="modal fade" id="posModal" tabindex="-1" aria-labelledby="posModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-fullscreen">
        <div class="modal-content">
            <div class="modal-header bg-success text-white">
                <h5 class="modal-title" id="posModalLabel">
                    <i class="fas fa-cash-register"></i>
                    Point of Sale System
                </h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body" id="posModalBody">
                <div class="loading-state">
                    <div class="spinner-border text-success" role="status">
                        <span class="visually-hidden">Loading...</span>
                    </div>
                    <p>Loading POS system...</p>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Billings Modal -->
<div class="modal fade" id="billingsModal" tabindex="-1" aria-labelledby="billingsModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-xl">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="billingsModalLabel">
                    <i class="fas fa-file-invoice-dollar"></i>
                    Unpaid Bills
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body" id="billingsModalBody">
                <div class="loading-state">
                    <div class="spinner-border text-primary" role="status">
                        <span class="visually-hidden">Loading...</span>
                    </div>
                    <p>Loading billing records...</p>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Patient Records Modal (nested modal for viewing specific patient records) -->
<div class="modal fade" id="patientRecordsModal" tabindex="-1" aria-labelledby="patientRecordsModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-xl">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="patientRecordsModalLabel">
                    <i class="fas fa-file-medical"></i>
                    Patient Medical Records
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body" id="patientRecordsModalBody">
                <div class="loading-state">
                    <div class="spinner-border text-primary" role="status">
                        <span class="visually-hidden">Loading...</span>
                    </div>
                    <p>Loading records...</p>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Users Management Modal -->
<div class="modal fade" id="usersModal" tabindex="-1" aria-labelledby="usersModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-xl">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="usersModalLabel">
                    <i class="fas fa-users"></i>
                    User Management
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div class="d-flex justify-content-between align-items-center mb-3">
                    <div class="btn-group" role="group">
                        <button type="button" class="btn btn-outline-primary active" 
                                hx-get="{% url 'bookings_v2:htmx_users_list' %}?role=all" 
                                hx-target="#usersListContainer">
                            <i class="fas fa-users"></i> All Users
                        </button>
                        <button type="button" class="btn btn-outline-success" 
                                hx-get="{% url 'bookings_v2:htmx_users_list' %}?role=staff" 
                                hx-target="#usersListContainer">
                            <i class="fas fa-user-shield"></i> Staff
                        </button>
                        <button type="button" class="btn btn-outline-info" 
                                hx-get="{% url 'bookings_v2:htmx_users_list' %}?role=customer" 
                                hx-target="#usersListContainer">
                            <i class="fas fa-user"></i> Customers
                        </button>
                        <button type="button" class="btn btn-outline-danger" 
                                hx-get="{% url 'bookings_v2:htmx_users_list' %}?role=superuser" 
                                hx-target="#usersListContainer">
                            <i class="fas fa-crown"></i> Superusers
                        </button>
                    </div>
                    <button type="button" class="btn btn-primary" 
                            hx-get="{% url 'bookings_v2:htmx_user_create_form' %}" 
                            hx-target="#userEditModalBody"
                            data-bs-toggle="modal" 
                            data-bs-target="#userEditModal">
                        <i class="fas fa-user-plus"></i> Create New User
                    </button>
                </div>
                <div id="usersListContainer">
                    <div class="loading-state">
                        <div class="spinner-border text-primary" role="status">
                            <span class="visually-hidden">Loading...</span>
                        </div>
                        <p>Loading users...</p>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- User Detail Modal -->
<div class="modal fade" id="userDetailModal" tabindex="-1" aria-labelledby="userDetailModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="userDetailModalLabel">
                    <i class="fas fa-user-circle"></i>
                    User Details
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body" id="userDetailModalBody">
                <div class="loading-state">
                    <div class="spinner-border text-primary" role="status">
                        <span class="visually-hidden">Loading...</span>
                    </div>
                    <p>Loading user details...</p>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- User Edit/Create Modal -->
<div class="modal fade" id="userEditModal" tabindex="-1" aria-labelledby="userEditModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="userEditModalLabel">
                    <i class="fas fa-user-edit"></i>
                    <span id="userEditModalTitle">Edit User</span>
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body" id="userEditModalBody">
                <div class="loading-state">
                    <div class="spinner-border text-primary" role="status">
                        <span class="visually-hidden">Loading...</span>
                    </div>
                    <p>Loading form...</p>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Pending Bookings Modal -->
<div class="modal fade" id="pendingBookingsModal" tabindex="-1" aria-labelledby="pendingBookingsModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-xl">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="pendingBookingsModalLabel">
                    <i class="fas fa-clock"></i>
                    Pending Bookings
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div class="d-flex justify-content-between align-items-center mb-3">
                    <p class="mb-0 text-muted">
                        <i class="fas fa-info-circle"></i>
                        Review and accept or decline pending bookings. Accepting a booking will create patient records and confirm the appointment.
                    </p>
                    <button type="button" class="btn btn-sm btn-outline-primary" 
                            hx-get="{% url 'bookings_v2:htmx_pending_bookings' %}" 
                            hx-target="#pendingBookingsContainer">
                        <i class="fas fa-sync-alt"></i> Refresh
                    </button>
                </div>
                <div id="pendingBookingsContainer">
                    <div class="loading-state">
                        <div class="spinner-border text-primary" role="status">
                            <span class="visually-hidden">Loading...</span>
                        </div>
                        <p>Loading pending bookings...</p>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Medical Images Modal -->
<div class="modal fade" id="medicalImagesModal" tabindex="-1" aria-labelledby="medicalImagesModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-xl">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="medicalImagesModalLabel">
                    <i class="fas fa-images"></i>
                    Medical Images
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body" id="medicalImagesModalBody">
                <div class="loading-state">
                    <div class="spinner-border text-primary" role="status">
                        <span class="visually-hidden">Loading...</span>
                    </div>
                    <p>Loading medical images...</p>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Prescriptions Modal -->
<div class="modal fade" id="prescriptionsModal" tabindex="-1" aria-labelledby="prescriptionsModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header bg-success text-white">
                <h5 class="modal-title" id="prescriptionsModalLabel">
                    <i class="fas fa-pills"></i>
                    Prescriptions
                </h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body" id="prescriptionsModalBody">
                <div class="loading-state">
                    <div class="spinner-border text-success" role="status">
                        <span class="visually-hidden">Loading...</span>
                    </div>
                    <p>Loading prescriptions...</p>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Global Image Crop Modal -->
<div class="modal fade" id="globalCropModal" tabindex="-1" aria-hidden="true" data-bs-backdrop="static" data-bs-keyboard="false">
    <div class="modal-dialog modal-lg modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">
                    <i class="fas fa-crop"></i> Crop Image
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close" id="globalCropModalClose"></button>
            </div>
            <div class="modal-body">
                <!-- Cropper Container -->
                <div class="mb-3">
                    <div style="max-height: 400px; overflow: hidden;">
                        <img id="globalCropperImage" src="" alt="Image to crop" style="max-width: 100%;">
                    </div>
                </div>
                
                <!-- Crop Controls -->
                <div class="row g-2">
                    <div class="col-md-6">
                        <label class="form-label small">Aspect Ratio</label>
                        <div class="btn-group w-100" role="group" id="globalAspectRatioGroup">
                            <button type="button" class="btn btn-sm btn-outline-secondary" data-ratio="free">Free</button>
                            <button type="button" class="btn btn-sm btn-outline-secondary active" data-ratio="1">Square</button>
                            <button type="button" class="btn btn-sm btn-outline-secondary" data-ratio="1.7778">16:9</button>
                            <button type="button" class="btn btn-sm btn-outline-secondary" data-ratio="1.3333">4:3</button>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <label class="form-label small">Actions</label>
                        <div class="btn-group w-100" role="group">
                            <button type="button" class="btn btn-sm btn-outline-secondary" id="globalRotateLeft" title="Rotate Left">
                                <i class="fas fa-undo"></i>
                            </button>
                            <button type="button" class="btn btn-sm btn-outline-secondary" id="globalRotateRight" title="Rotate Right">
                                <i class="fas fa-redo"></i>
                            </button>
                            <button type="button" class="btn btn-sm btn-outline-secondary" id="globalFlipHorizontal" title="Flip Horizontal">
                                <i class="fas fa-arrows-alt-h"></i>
                            </button>
                            <button type="button" class="btn btn-sm btn-outline-secondary" id="globalFlipVertical" title="Flip Vertical">
                                <i class="fas fa-arrows-alt-v"></i>
                            </button>
                            <button type="button" class="btn btn-sm btn-outline-secondary" id="globalResetCrop" title="Reset">
                                <i class="fas fa-sync"></i>
                            </button>
                        </div>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal" id="globalCropCancel">
                    <i class="fas fa-times"></i> Cancel
                </button>
                <button type="button" class="btn btn-success" id="globalCropAndSave">
                    <i class="fas fa-check"></i> Crop & Use
                </button>
            </div>
        </div>
    </div>
</div>

{% endblock %}

{% block extra_js %}
<script>
    // ===== TOAST NOTIFICATION SYSTEM =====
    function showToast(message = 'Action completed successfully!', type = 'success', duration = 3000) {
        const container = document.getElementById('toastContainer');
        
        const icons = {
            success: 'fa-check-circle',
            error: 'fa-exclamation-circle',
            warning: 'fa-exclamation-triangle',
            info: 'fa-info-circle'
        };
        
        const titles = {
            success: 'Success',
            error: 'Error',
            warning: 'Warning',
            info: 'Info'
        };
        
        const toast = document.createElement('div');
        toast.className = `toast-notification toast-${type}`;
        toast.innerHTML = `
            <div class="toast-icon">
                <i class="fas ${icons[type]}"></i>
            </div>
            <div class="toast-content">
                <div class="toast-title">${titles[type]}</div>
                <p class="toast-message">${message}</p>
            </div>
            <button class="toast-close" onclick="this.parentElement.remove()">
                <i class="fas fa-times"></i>
            </button>
        `;
        
        container.appendChild(toast);
        
        // Auto-remove after duration
        setTimeout(() => {
            toast.style.animation = 'fadeOut 0.3s ease';
            setTimeout(() => toast.remove(), 300);
        }, duration);
    }
    
    // Listen for HTMX showToast trigger
    document.body.addEventListener('htmx:afterSwap', function(event) {
        const trigger = event.detail.xhr.getResponseHeader('HX-Trigger');
        if (trigger && trigger.includes('showToast')) {
            // Determine message based on context
            let message = 'Operation completed successfully!';
            
            if (trigger.includes('userCreated')) {
                message = 'User created successfully!';
            } else if (trigger.includes('userUpdated')) {
                message = 'User updated successfully!';
            } else if (event.detail.target.id === 'servicesListContainer') {
                message = 'Service updated successfully!';
            } else if (event.detail.target.id === 'inventoryListContainer') {
                message = 'Inventory updated successfully!';
            }
            
            showToast(message, 'success');
        }
    });
    
    // Clear modal body when opening for create (to prevent edit form from showing)
    document.addEventListener('DOMContentLoaded', function() {
        const userEditModal = document.getElementById('userEditModal');
        if (userEditModal) {
            userEditModal.addEventListener('show.bs.modal', function(event) {
                const button = event.relatedTarget; // Button that triggered the modal
                
                // Check if this is a create button by checking the hx-get attribute
                if (button && button.hasAttribute('hx-get')) {
                    const hxGetUrl = button.getAttribute('hx-get');
                    
                    // If URL contains 'create-form', it's a create action
                    if (hxGetUrl.includes('create-form')) {
                        // Clear the modal body before loading create form
                        const modalBody = document.getElementById('userEditModalBody');
                        const modalTitle = document.getElementById('userEditModalTitle');
                        if (modalBody) {
                            modalBody.innerHTML = '<div class="loading-state"><div class="spinner-border text-primary" role="status"><span class="visually-hidden">Loading...</span></div><p>Loading form...</p></div>';
                        }
                        if (modalTitle) {
                            modalTitle.textContent = 'Create User';
                        }
                    } 
                    // If URL contains 'user_edit', it's an edit action
                    else if (hxGetUrl.includes('user/') && hxGetUrl.includes('/edit/')) {
                        const modalTitle = document.getElementById('userEditModalTitle');
                        if (modalTitle) {
                            modalTitle.textContent = 'Edit User';
                        }
                    }
                }
            });
        }
    });
    
    // HTMX event listeners for better UX - No loading buffer
    document.body.addEventListener('htmx:beforeRequest', function(event) {
        // No loading buffer - HTMX handles transitions smoothly
    });
    
    document.body.addEventListener('htmx:afterSwap', function(event) {
        // Initialize any tooltips or popovers after content swap
        const tooltips = document.querySelectorAll('[data-bs-toggle="tooltip"]');
        tooltips.forEach(tooltip => new bootstrap.Tooltip(tooltip));
    });
    
    // Success toast notification
    document.body.addEventListener('htmx:afterRequest', function(event) {
        if (event.detail.successful && event.detail.xhr.status === 200) {
            // Check if response contains a success message
            const response = event.detail.xhr.responseText;
            if (response.includes('success')) {
                // You can implement a toast notification here if needed
                console.log('Operation completed successfully');
            }
        }
    });
    
    // Error handling
    document.body.addEventListener('htmx:responseError', function(event) {
        console.error('HTMX Error:', event.detail);
        const target = event.detail.target;
        if (target) {
            target.innerHTML = `
                <div class="empty-state">
                    <i class="fas fa-exclamation-circle"></i>
                    <h3>Error Loading Data</h3>
                    <p>Failed to load content. Please try again.</p>
                    <button class="btn btn-primary" onclick="location.reload()">Refresh Page</button>
                </div>
            `;
        }
    });
</script>

<!-- Cropper.js Library -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/cropperjs/1.6.1/cropper.min.js"></script>
<!-- Global Cropper Module -->
<script src="{% static 'js/global_cropper.js' %}"></script>

{% endblock %}
