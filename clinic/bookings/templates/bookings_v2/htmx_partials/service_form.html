<!-- HTMX Partial: Create/Edit Service Form -->
<form hx-post="{% if service %}{% url 'bookings_v2:htmx_service_update' service.id %}{% else %}{% url 'bookings_v2:htmx_service_create' %}{% endif %}"
      hx-target="#servicesModalBody"
      hx-swap="innerHTML"
      hx-encoding="multipart/form-data"
      id="serviceForm">
    
    {% csrf_token %}
    
    <div class="alert alert-info mb-4">
        <i class="fas fa-info-circle"></i>
        {% if service %}
        Editing service: <strong>{{ service.name }}</strong>
        {% else %}
        Create a new service offering for the clinic.
        {% endif %}
    </div>
    
    <!-- Service Name -->
    <div class="mb-3">
        <label for="name" class="form-label">
            <i class="fas fa-concierge-bell text-primary"></i> Service Name *
        </label>
        <input type="text" 
               class="form-control" 
               id="name" 
               name="name" 
               value="{{ service.name|default:'' }}"
               placeholder="e.g., Skin Consultation"
               required>
    </div>
    
    <!-- Description -->
    <div class="mb-3">
        <label for="description" class="form-label">
            <i class="fas fa-align-left text-primary"></i> Description *
        </label>
        <textarea class="form-control" 
                  id="description" 
                  name="description" 
                  rows="4"
                  placeholder="Detailed description of the service..."
                  required>{{ service.description|default:'' }}</textarea>
        <small class="text-muted">Describe what this service includes</small>
    </div>
    
    <!-- Price -->
    <div class="mb-3">
        <label for="price" class="form-label">
            <i class="fas fa-tag text-primary"></i> Price *
        </label>
        <div class="input-group">
            <span class="input-group-text">â‚±</span>
            <input type="number" 
                   class="form-control" 
                   id="price" 
                   name="price" 
                   step="0.01"
                   min="0"
                   value="{{ service.price|default:'0.00' }}"
                   required>
        </div>
        <small class="text-muted">Service price in Philippine Pesos</small>
    </div>
    
    <!-- Image Upload -->
    <div class="mb-3">
        <label for="image" class="form-label">
            <i class="fas fa-image text-primary"></i> Service Image {% if not service %}*{% endif %}
        </label>
        
        {% if service.image %}
        <div class="mb-2">
            <img src="{{ service.image.url }}" 
                 alt="{{ service.name }}" 
                 style="max-width: 200px; height: auto; border-radius: 8px; border: 2px solid #dee2e6;">
            <p class="text-muted small mb-0 mt-1">Current image</p>
        </div>
        {% endif %}
        
        <input type="file" 
               class="form-control" 
               id="image" 
               name="image" 
               accept="image/*"
               {% if not service %}required{% endif %}
               style="display: none;">
        
        <!-- Custom Upload Button -->
        <div class="d-flex gap-2 align-items-center">
            <button type="button" class="btn btn-outline-primary" id="selectImageBtn">
                <i class="fas fa-upload"></i> Select Image
            </button>
            <span id="selectedFileName" class="text-muted small"></span>
        </div>
        
        <small class="text-muted d-block mt-1">
            {% if service %}
            Leave empty to keep current image. Upload a new image to replace it.
            {% else %}
            Upload an image for this service (JPG, PNG, etc.)
            {% endif %}
        </small>
        
        <!-- Image Preview (will show cropped image) -->
        <div id="croppedPreview" style="display: none;" class="mt-2">
            <p class="text-muted small mb-1">Cropped preview:</p>
            <img id="croppedImage" src="" alt="Cropped preview" 
                 style="max-width: 200px; height: auto; border-radius: 8px; border: 2px solid #28a745;">
        </div>
    </div>
    
    <!-- Action Buttons -->
    <div class="d-flex justify-content-end gap-2 mt-4">
        <button type="button" 
                class="btn btn-secondary"
                hx-get="{% url 'bookings_v2:htmx_services_list' %}"
                hx-target="#servicesModalBody"
                hx-swap="innerHTML">
            <i class="fas fa-times"></i> Cancel
        </button>
        <button type="submit" class="btn btn-primary">
            <i class="fas fa-save"></i> {% if service %}Update{% else %}Create{% endif %} Service
        </button>
    </div>
</form>

<script>
(function() {
    const fileInput = document.getElementById('image');
    const selectImageBtn = document.getElementById('selectImageBtn');
    const selectedFileNameSpan = document.getElementById('selectedFileName');
    
    // Click select button to trigger file input
    selectImageBtn.addEventListener('click', function() {
        fileInput.click();
    });
    
    // When file is selected, open the global crop modal
    fileInput.addEventListener('change', async function(e) {
        const file = e.target.files[0];
        if (!file || !file.type.startsWith('image/')) {
            if (file) {
                alert('Please select a valid image file.');
                fileInput.value = '';
            }
            return;
        }
        
        // Check if GlobalCropper is available
        if (!window.GlobalCropper || typeof window.GlobalCropper.open !== 'function') {
            console.error('GlobalCropper is not available');
            alert('Image cropper is not loaded. Please refresh the page and try again.');
            fileInput.value = '';
            return;
        }
        
        try {
            // Open the global cropper modal (aspect ratio 1:1 by default)
            const result = await window.GlobalCropper.open(file, { aspectRatio: 1 });
            
            // Create a DataTransfer to set the file input with the cropped image
            const dataTransfer = new DataTransfer();
            dataTransfer.items.add(result.file);
            fileInput.files = dataTransfer.files;
            
            // Show preview
            const preview = document.getElementById('croppedImage');
            const previewContainer = document.getElementById('croppedPreview');
            preview.src = result.dataURL;
            previewContainer.style.display = 'block';
            
            // Update filename display
            selectedFileNameSpan.textContent = result.fileName + ' (cropped)';
            selectedFileNameSpan.classList.add('text-success');
            
        } catch (error) {
            // User cancelled or error occurred
            console.log('Crop cancelled or failed:', error);
            fileInput.value = '';
            selectedFileNameSpan.textContent = 'No file selected';
            selectedFileNameSpan.classList.remove('text-success');
        }
    });
})();
</script>
