<!-- HTMX Partial: Create/Edit Patient Form -->
<form hx-post="{% if patient %}{% url 'bookings_v2:htmx_patient_update' patient.id %}{% else %}{% url 'bookings_v2:htmx_patient_create' %}{% endif %}"
      hx-target="#patientsModalBody"
      hx-swap="innerHTML">
    
    {% csrf_token %}
    
    <div class="alert alert-info mb-4">
        <i class="fas fa-info-circle"></i>
        {% if patient %}
        Editing patient profile for <strong>{{ patient.user.get_full_name }}</strong>
        {% else %}
        Creating a new patient will also create a user account. The patient will receive login credentials via email.
        {% endif %}
    </div>
    
    <!-- User Account Information -->
    <h6 class="text-primary mb-3"><i class="fas fa-user-lock"></i> Account Information</h6>
    
    <div class="row">
        <div class="col-md-6 mb-3">
            <label for="first_name" class="form-label">First Name *</label>
            <input type="text" 
                   class="form-control" 
                   id="first_name" 
                   name="first_name" 
                   value="{{ patient.user.first_name|default:'' }}"
                   required>
        </div>
        
        <div class="col-md-6 mb-3">
            <label for="last_name" class="form-label">Last Name *</label>
            <input type="text" 
                   class="form-control" 
                   id="last_name" 
                   name="last_name" 
                   value="{{ patient.user.last_name|default:'' }}"
                   required>
        </div>
    </div>
    
    <div class="row">
        <div class="col-md-6 mb-3">
            <label for="username" class="form-label">Username *</label>
            <input type="text" 
                   class="form-control" 
                   id="username" 
                   name="username" 
                   value="{{ patient.user.username|default:'' }}"
                   {% if patient %}readonly{% endif %}
                   required>
            {% if not patient %}
            <small class="text-muted">This will be used for login</small>
            {% endif %}
        </div>
        
        <div class="col-md-6 mb-3">
            <label for="email" class="form-label">Email *</label>
            <input type="email" 
                   class="form-control" 
                   id="email" 
                   name="email" 
                   value="{{ patient.user.email|default:'' }}"
                   required>
        </div>
    </div>
    
    {% if not patient %}
    <!-- Password fields only for new patients -->
    <div class="row">
        <div class="col-md-6 mb-3">
            <label for="password1" class="form-label">Password *</label>
            <input type="password" 
                   class="form-control" 
                   id="password1" 
                   name="password1" 
                   required>
        </div>
        
        <div class="col-md-6 mb-3">
            <label for="password2" class="form-label">Confirm Password *</label>
            <input type="password" 
                   class="form-control" 
                   id="password2" 
                   name="password2" 
                   required>
        </div>
    </div>
    {% endif %}
    
    <hr class="my-4">
    
    <!-- Personal Information -->
    <h6 class="text-primary mb-3"><i class="fas fa-id-card"></i> Personal Information</h6>
    
    <div class="row">
        <div class="col-md-4 mb-3">
            <label for="date_of_birth" class="form-label">Date of Birth *</label>
            <input type="date" 
                   class="form-control" 
                   id="date_of_birth" 
                   name="date_of_birth" 
                   value="{{ patient.date_of_birth|date:'Y-m-d'|default:'' }}"
                   max="{{ today }}"
                   required>
        </div>
        
        <div class="col-md-4 mb-3">
            <label for="gender" class="form-label">Gender *</label>
            <select class="form-select" id="gender" name="gender" required>
                <option value="">Select...</option>
                <option value="M" {% if patient.gender == 'M' %}selected{% endif %}>Male</option>
                <option value="F" {% if patient.gender == 'F' %}selected{% endif %}>Female</option>
                <option value="O" {% if patient.gender == 'O' %}selected{% endif %}>Other</option>
            </select>
        </div>
        
        <div class="col-md-4 mb-3">
            <label for="blood_type" class="form-label">Blood Type</label>
            <select class="form-select" id="blood_type" name="blood_type">
                <option value="UK" {% if patient.blood_type == 'UK' or not patient %}selected{% endif %}>Unknown</option>
                <option value="A+" {% if patient.blood_type == 'A+' %}selected{% endif %}>A+</option>
                <option value="A-" {% if patient.blood_type == 'A-' %}selected{% endif %}>A-</option>
                <option value="B+" {% if patient.blood_type == 'B+' %}selected{% endif %}>B+</option>
                <option value="B-" {% if patient.blood_type == 'B-' %}selected{% endif %}>B-</option>
                <option value="AB+" {% if patient.blood_type == 'AB+' %}selected{% endif %}>AB+</option>
                <option value="AB-" {% if patient.blood_type == 'AB-' %}selected{% endif %}>AB-</option>
                <option value="O+" {% if patient.blood_type == 'O+' %}selected{% endif %}>O+</option>
                <option value="O-" {% if patient.blood_type == 'O-' %}selected{% endif %}>O-</option>
            </select>
        </div>
    </div>
    
    <!-- Contact Information -->
    <h6 class="text-primary mb-3"><i class="fas fa-address-book"></i> Contact Information</h6>
    
    <div class="row">
        <div class="col-md-6 mb-3">
            <label for="phone" class="form-label">Phone</label>
            <input type="tel" 
                   class="form-control" 
                   id="phone" 
                   name="phone" 
                   value="{{ patient.phone|default:'' }}">
        </div>
        
        <div class="col-md-6 mb-3">
            <label for="address" class="form-label">Address</label>
            <input type="text" 
                   class="form-control" 
                   id="address" 
                   name="address" 
                   value="{{ patient.address|default:'' }}">
        </div>
    </div>
    
    <!-- Emergency Contact -->
    <h6 class="text-primary mb-3"><i class="fas fa-phone-square"></i> Emergency Contact</h6>
    
    <div class="row">
        <div class="col-md-6 mb-3">
            <label for="emergency_contact_name" class="form-label">Contact Name</label>
            <input type="text" 
                   class="form-control" 
                   id="emergency_contact_name" 
                   name="emergency_contact_name" 
                   value="{{ patient.emergency_contact_name|default:'' }}">
        </div>
        
        <div class="col-md-6 mb-3">
            <label for="emergency_contact_phone" class="form-label">Contact Phone</label>
            <input type="tel" 
                   class="form-control" 
                   id="emergency_contact_phone" 
                   name="emergency_contact_phone" 
                   value="{{ patient.emergency_contact_phone|default:'' }}">
        </div>
    </div>
    
    <!-- Medical Information -->
    <h6 class="text-primary mb-3"><i class="fas fa-notes-medical"></i> Medical Information</h6>
    
    <div class="mb-3">
        <label for="allergies" class="form-label">Allergies</label>
        <textarea class="form-control" 
                  id="allergies" 
                  name="allergies" 
                  rows="2"
                  placeholder="List any known allergies">{{ patient.allergies|default:'' }}</textarea>
    </div>
    
    <div class="mb-3">
        <label for="current_medications" class="form-label">Current Medications</label>
        <textarea class="form-control" 
                  id="current_medications" 
                  name="current_medications" 
                  rows="2"
                  placeholder="Current medications and dosages">{{ patient.current_medications|default:'' }}</textarea>
    </div>
    
    <div class="mb-3">
        <label for="medical_history" class="form-label">Medical History</label>
        <textarea class="form-control" 
                  id="medical_history" 
                  name="medical_history" 
                  rows="3"
                  placeholder="Previous medical conditions and surgeries">{{ patient.medical_history|default:'' }}</textarea>
    </div>
    
    <!-- Action Buttons -->
    <div class="d-flex justify-content-end gap-2 mt-4">
        <button type="button" 
                class="btn btn-secondary"
                hx-get="{% url 'bookings_v2:htmx_patients_list' %}"
                hx-target="#patientsModalBody"
                hx-swap="innerHTML">
            <i class="fas fa-times"></i> Cancel
        </button>
        <button type="submit" class="btn btn-primary">
            <i class="fas fa-save"></i> {% if patient %}Update{% else %}Create{% endif %} Patient
        </button>
    </div>
</form>

<script>
    // Set maximum date to today for DOB
    document.getElementById('date_of_birth').max = new Date().toISOString().split('T')[0];
    
    {% if not patient %}
    // Password validation for new patients
    const password1 = document.getElementById('password1');
    const password2 = document.getElementById('password2');
    
    password2.addEventListener('input', function() {
        if (password1.value !== password2.value) {
            password2.setCustomValidity('Passwords do not match');
        } else {
            password2.setCustomValidity('');
        }
    });
    {% endif %}
</script>
