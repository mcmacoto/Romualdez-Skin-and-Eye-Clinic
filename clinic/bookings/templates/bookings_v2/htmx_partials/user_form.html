{% load static %}

<form id="userForm" 
      hx-post="{% if edit_user %}{% url 'bookings_v2:htmx_user_update' edit_user.id %}{% else %}{% url 'bookings_v2:htmx_user_create' %}{% endif %}" 
      hx-target="#usersListContainer"
      hx-swap="innerHTML"
      hx-encoding="multipart/form-data">
    {% csrf_token %}
    
    <div class="row">
        <div class="col-md-12">
            <div class="alert alert-info">
                <i class="fas fa-info-circle"></i>
                {% if edit_user %}
                    <strong>Edit User:</strong> Modify the user details below. Only superusers can modify other staff accounts.
                {% else %}
                    <strong>Create New User:</strong> Fill in the required fields to create a new user account.
                {% endif %}
            </div>
        </div>
    </div>
    
    {% if edit_user and patient_profile %}
    <!-- Profile Picture Section -->
    <div class="row mb-3">
        <div class="col-md-12">
            <div class="card">
                <div class="card-body text-center">
                    <div class="profile-picture-wrapper position-relative d-inline-block" style="cursor: pointer;" onclick="document.getElementById('profile_picture_input').click();">
                        <div class="profile-picture-container position-relative" style="width: 120px; height: 120px;">
                            {% if patient_profile.profile_picture %}
                                <img id="profilePicturePreview" src="{{ patient_profile.profile_picture.url }}" alt="Profile Picture" class="rounded-circle" style="width: 120px; height: 120px; object-fit: cover; border: 3px solid #007bff; position: absolute; top: 0; left: 0; display: block; z-index: 2;">
                                <div id="defaultAvatar" class="rounded-circle d-flex align-items-center justify-content-center" style="width: 120px; height: 120px; background-color: #6c757d; border: 3px solid #ccc; position: absolute; top: 0; left: 0; display: none; z-index: 1;">
                                    <i class="fas fa-user fa-3x text-white"></i>
                                </div>
                            {% else %}
                                <img id="profilePicturePreview" src="" alt="Profile Picture" class="rounded-circle" style="width: 120px; height: 120px; object-fit: cover; border: 3px solid #007bff; position: absolute; top: 0; left: 0; display: none; z-index: 2;">
                                <div id="defaultAvatar" class="rounded-circle d-flex align-items-center justify-content-center" style="width: 120px; height: 120px; background-color: #6c757d; border: 3px solid #ccc; position: absolute; top: 0; left: 0; display: block; z-index: 1;">
                                    <i class="fas fa-user fa-3x text-white"></i>
                                </div>
                            {% endif %}
                            <div class="camera-overlay position-absolute top-0 start-0 w-100 h-100 d-flex align-items-center justify-content-center" style="background-color: rgba(0,0,0,0.5); border-radius: 50%; opacity: 0; transition: opacity 0.3s; z-index: 10;">
                                <i class="fas fa-camera fa-2x text-white"></i>
                            </div>
                        </div>
                    </div>
                    <input type="file" id="profile_picture_input" name="profile_picture" accept="image/*" style="display: none;" onchange="previewProfilePicture(this)">
                    <div class="mt-3">
                        <label class="form-label fw-bold mb-1">
                            <i class="fas fa-camera"></i> Profile Picture
                        </label>
                        <div>
                            <small class="text-muted">Click on the image to upload a new profile picture</small>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    {% endif %}
    
    <div class="row">
        <!-- Basic Information -->
        <div class="col-md-6">
            <div class="mb-3">
                <label for="username" class="form-label">
                    <i class="fas fa-user"></i> Username <span class="text-danger">*</span>
                </label>
                <input type="text" class="form-control" id="username" name="username" 
                       value="{% if edit_user %}{{ edit_user.username }}{% endif %}" 
                       {% if edit_user %}readonly{% endif %}
                       required>
                <small class="form-text text-muted">Username cannot be changed after creation</small>
            </div>
        </div>
        
        <div class="col-md-6">
            <div class="mb-3">
                <label for="email" class="form-label">
                    <i class="fas fa-envelope"></i> Email <span class="text-danger">*</span>
                </label>
                <input type="email" class="form-control" id="email" name="email" 
                       value="{% if edit_user %}{{ edit_user.email }}{% endif %}" 
                       required>
            </div>
        </div>
    </div>
    
    <div class="row">
        <div class="col-md-6">
            <div class="mb-3">
                <label for="first_name" class="form-label">
                    <i class="fas fa-id-card"></i> First Name
                </label>
                <input type="text" class="form-control" id="first_name" name="first_name" 
                       value="{% if edit_user %}{{ edit_user.first_name }}{% endif %}">
            </div>
        </div>
        
        <div class="col-md-6">
            <div class="mb-3">
                <label for="last_name" class="form-label">
                    <i class="fas fa-id-card"></i> Last Name
                </label>
                <input type="text" class="form-control" id="last_name" name="last_name" 
                       value="{% if edit_user %}{{ edit_user.last_name }}{% endif %}">
            </div>
        </div>
    </div>
    
    {% if not edit_user %}
    <div class="row">
        <div class="col-md-6">
            <div class="mb-3">
                <label for="password1" class="form-label">
                    <i class="fas fa-lock"></i> Password <span class="text-danger">*</span>
                </label>
                <input type="password" class="form-control" id="password1" name="password1" required>
                <small class="form-text text-muted">Minimum 8 characters</small>
            </div>
        </div>
        
        <div class="col-md-6">
            <div class="mb-3">
                <label for="password2" class="form-label">
                    <i class="fas fa-lock"></i> Confirm Password <span class="text-danger">*</span>
                </label>
                <input type="password" class="form-control" id="password2" name="password2" required>
            </div>
        </div>
    </div>
    {% endif %}
    
    <hr>
    
    <!-- Permissions Section -->
    <div class="row">
        <div class="col-md-12">
            <h5 class="mb-3">
                <i class="fas fa-shield-alt text-success"></i> Permissions & Access
            </h5>
        </div>
    </div>
    
    <div class="row">
        <div class="col-md-4">
            <div class="form-check form-switch mb-3">
                <input class="form-check-input" type="checkbox" id="is_active" name="is_active" 
                       {% if not edit_user or edit_user.is_active %}checked{% endif %}>
                <label class="form-check-label" for="is_active">
                    <i class="fas fa-check-circle"></i> <strong>Active Account</strong>
                    <br><small class="text-muted">User can log in and access the system</small>
                </label>
            </div>
        </div>
        
        <div class="col-md-4">
            {% if request.user.is_superuser %}
            <div class="form-check form-switch mb-3">
                <input class="form-check-input" type="checkbox" id="is_staff" name="is_staff" 
                       {% if edit_user and edit_user.is_staff %}checked{% endif %}
                       onchange="toggleStaffWarning(this)">
                <label class="form-check-label" for="is_staff">
                    <i class="fas fa-user-shield"></i> <strong>Staff Status</strong>
                    <br><small class="text-muted">Can access admin dashboard</small>
                </label>
            </div>
            {% else %}
            <div class="alert alert-warning py-2">
                <small><i class="fas fa-exclamation-triangle"></i> Only superusers can grant staff status</small>
            </div>
            {% endif %}
        </div>
        
        <div class="col-md-4">
            {% if request.user.is_superuser %}
            <div class="form-check form-switch mb-3">
                <input class="form-check-input" type="checkbox" id="is_superuser" name="is_superuser" 
                       {% if edit_user and edit_user.is_superuser %}checked{% endif %}
                       onchange="toggleSuperuserWarning(this)">
                <label class="form-check-label" for="is_superuser">
                    <i class="fas fa-crown"></i> <strong>Superuser</strong>
                    <br><small class="text-muted">Full system access</small>
                </label>
            </div>
            {% else %}
            <div class="alert alert-danger py-2">
                <small><i class="fas fa-ban"></i> Only superusers can grant superuser status</small>
            </div>
            {% endif %}
        </div>
    </div>
    
    <div id="staffWarning" class="alert alert-warning" style="display: none;">
        <i class="fas fa-exclamation-triangle"></i>
        <strong>Staff Access Warning:</strong> This user will be able to access the admin dashboard and manage clinic data.
    </div>
    
    <div id="superuserWarning" class="alert alert-danger" style="display: none;">
        <i class="fas fa-exclamation-circle"></i>
        <strong>Superuser Warning:</strong> This user will have complete access to all system functions, including user management and system settings.
    </div>
    
    <hr>
    
    <!-- Groups -->
    <div class="row">
        <div class="col-md-12">
            <h5 class="mb-3">
                <i class="fas fa-users text-info"></i> User Groups
            </h5>
            
            <div class="form-check mb-2">
                <input class="form-check-input" type="checkbox" id="group_staff" name="groups" value="Clinic Staff"
                       {% if user_groups and 'Clinic Staff' in user_groups %}checked{% endif %}>
                <label class="form-check-label" for="group_staff">
                    <i class="fas fa-user-md"></i> Clinic Staff
                </label>
            </div>
            
            <div class="form-check mb-2">
                <input class="form-check-input" type="checkbox" id="group_customer" name="groups" value="Customer"
                       {% if user_groups and 'Customer' in user_groups %}checked{% endif %}>
                <label class="form-check-label" for="group_customer">
                    <i class="fas fa-user"></i> Customer
                </label>
            </div>
        </div>
    </div>
    
    <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
            <i class="fas fa-times"></i> Cancel
        </button>
        {% if edit_user %}
        <button type="button" class="btn btn-warning" 
                hx-get="{% url 'bookings_v2:htmx_user_password_form' edit_user.id %}" 
                hx-target="#userPasswordModalBody"
                data-bs-toggle="modal" 
                data-bs-target="#userPasswordModal"
                data-bs-dismiss="modal">
            <i class="fas fa-key"></i> Reset Password
        </button>
        {% endif %}
        <button type="submit" class="btn btn-primary">
            <i class="fas fa-save"></i> {% if edit_user %}Update User{% else %}Create User{% endif %}
        </button>
    </div>
</form>

<script>
    let croppedProfilePicture = null;
    
    async function previewProfilePicture(input) {
        if (input.files && input.files[0]) {
            const file = input.files[0];
            
            // Use GlobalCropper to crop the image
            if (typeof GlobalCropper !== 'undefined') {
                try {
                    const result = await GlobalCropper.open(file, {
                        aspectRatio: 1 // Square aspect ratio for profile pictures
                    });
                    
                    // Store the cropped file
                    croppedProfilePicture = result.file;
                    
                    // Update the file input with the cropped file
                    const dataTransfer = new DataTransfer();
                    dataTransfer.items.add(result.file);
                    input.files = dataTransfer.files;
                    
                    // Update preview with cropped image
                    const preview = document.getElementById('profilePicturePreview');
                    const defaultAvatar = document.getElementById('defaultAvatar');
                    
                    preview.src = result.dataURL;
                    preview.style.display = 'block';
                    preview.style.borderColor = '#28a745'; // Green border to indicate change
                    
                    if (defaultAvatar) {
                        defaultAvatar.style.display = 'none';
                    }
                } catch (error) {
                    console.log('Cropping cancelled or failed:', error.message);
                    // Reset the file input if user cancelled
                    input.value = '';
                    croppedProfilePicture = null;
                }
            } else {
                // Fallback if GlobalCropper is not available
                const reader = new FileReader();
                
                reader.onload = function(e) {
                    const preview = document.getElementById('profilePicturePreview');
                    const defaultAvatar = document.getElementById('defaultAvatar');
                    
                    preview.src = e.target.result;
                    preview.style.display = 'block';
                    preview.style.borderColor = '#28a745';
                    
                    if (defaultAvatar) {
                        defaultAvatar.style.display = 'none';
                    }
                }
                
                reader.readAsDataURL(file);
            }
        }
    }
    
    // Add hover effect to profile picture
    document.addEventListener('DOMContentLoaded', function() {
        const wrapper = document.querySelector('.profile-picture-wrapper');
        const overlay = document.querySelector('.camera-overlay');
        
        if (wrapper && overlay) {
            wrapper.addEventListener('mouseenter', function() {
                overlay.style.opacity = '1';
            });
            
            wrapper.addEventListener('mouseleave', function() {
                overlay.style.opacity = '0';
            });
        }
    });
    
    function toggleStaffWarning(checkbox) {
        const warning = document.getElementById('staffWarning');
        warning.style.display = checkbox.checked ? 'block' : 'none';
    }
    
    function toggleSuperuserWarning(checkbox) {
        const warning = document.getElementById('superuserWarning');
        warning.style.display = checkbox.checked ? 'block' : 'none';
        
        // If superuser is checked, also check staff
        if (checkbox.checked) {
            document.getElementById('is_staff').checked = true;
            toggleStaffWarning(document.getElementById('is_staff'));
        }
    }
    
    // Password validation
    {% if not edit_user %}
    const password2Field = document.getElementById('password2');
    if (password2Field) {
        password2Field.addEventListener('input', function() {
            const password1 = document.getElementById('password1').value;
            const password2 = this.value;
            
            if (password1 !== password2) {
                this.setCustomValidity('Passwords do not match');
            } else {
                this.setCustomValidity('');
            }
        });
    }
    {% endif %}
    
    // Close modal on successful form submission
    document.body.addEventListener('htmx:afterSwap', function(event) {
        // Check if the swap target is the users list container (meaning successful save)
        if (event.detail.target.id === 'usersListContainer') {
            // Reset the cropped image
            croppedProfilePicture = null;
            
            // Close the user edit modal
            const modal = bootstrap.Modal.getInstance(document.getElementById('userEditModal'));
            if (modal) {
                modal.hide();
            }
        }
    });
</script>

<style>
    .form-check-label small {
        display: block;
        margin-top: 0.25rem;
    }
    
    .alert {
        font-size: 0.875rem;
    }
</style>
