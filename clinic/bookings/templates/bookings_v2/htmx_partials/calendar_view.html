<!-- Calendar View for Blocking/Unblocking Dates -->
<div class="calendar-container">
    <!-- Calendar Header -->
    <div class="d-flex justify-content-between align-items-center mb-3">
        <button class="btn btn-outline-primary btn-sm"
                hx-get="{% url 'bookings_v2:htmx_calendar_view' %}?year={{ prev_year }}&month={{ prev_month }}"
                hx-target="#calendarContainer"
                hx-swap="innerHTML">
            <i class="fas fa-chevron-left"></i> Previous
        </button>
        
        <h5 class="mb-0">
            <i class="fas fa-calendar-alt"></i>
            {{ month_name }} {{ year }}
        </h5>
        
        <button class="btn btn-outline-primary btn-sm"
                hx-get="{% url 'bookings_v2:htmx_calendar_view' %}?year={{ next_year }}&month={{ next_month }}"
                hx-target="#calendarContainer"
                hx-swap="innerHTML">
            Next <i class="fas fa-chevron-right"></i>
        </button>
    </div>

    <!-- Legend -->
    <div class="mb-3">
        <small>
            <span class="badge bg-success me-2">Available</span>
            <span class="badge bg-danger me-2">Blocked</span>
            <span class="badge" style="background-color: #dc3545; opacity: 0.8;" class="me-2">Sunday (Auto-blocked)</span>
            <span class="badge bg-secondary">Past Date</span>
        </small>
        <div class="text-muted mt-1">
            <small><i class="fas fa-info-circle"></i> Click on any future date (except Sundays) to block/unblock it. Sundays are automatically blocked.</small>
        </div>
    </div>

    <!-- Calendar Grid -->
    <div class="calendar-grid">
        <table class="table table-bordered table-sm" style="table-layout: fixed; width: 100%;">
            <thead>
                <tr class="text-center">
                    <th style="background-color: #f8f9fa; padding: 10px; font-weight: 600; width: 14.28%;">Sun</th>
                    <th style="background-color: #f8f9fa; padding: 10px; font-weight: 600; width: 14.28%;">Mon</th>
                    <th style="background-color: #f8f9fa; padding: 10px; font-weight: 600; width: 14.28%;">Tue</th>
                    <th style="background-color: #f8f9fa; padding: 10px; font-weight: 600; width: 14.28%;">Wed</th>
                    <th style="background-color: #f8f9fa; padding: 10px; font-weight: 600; width: 14.28%;">Thu</th>
                    <th style="background-color: #f8f9fa; padding: 10px; font-weight: 600; width: 14.28%;">Fri</th>
                    <th style="background-color: #f8f9fa; padding: 10px; font-weight: 600; width: 14.28%;">Sat</th>
                </tr>
            </thead>
            <tbody>
                {% for week in calendar_weeks %}
                    <tr>
                        {% for day_info in week %}
                            {% if day_info %}
                                {% if day_info.is_sunday %}
                                    <!-- Sunday - Always Blocked (Non-clickable) -->
                                    <td class="calendar-day sunday-blocked text-center p-2"
                                        style="background-color: #f8d7da; color: #721c24; min-height: 80px; height: 80px; vertical-align: top; cursor: not-allowed; width: 14.28%;">
                                        <strong>{{ day_info.day }}</strong>
                                        <br>
                                        <small class="text-danger">
                                            <i class="fas fa-ban"></i> Sunday
                                        </small>
                                    </td>
                                {% elif day_info.is_past %}
                                    <!-- Past Date -->
                                    <td class="calendar-day past-day text-center p-2"
                                        style="background-color: #f5f5f5; color: #999; min-height: 80px; height: 80px; vertical-align: top; width: 14.28%;">
                                        <strong>{{ day_info.day }}</strong>
                                    </td>
                                {% elif day_info.is_blocked %}
                                    <!-- Blocked Date -->
                                    <td class="calendar-day blocked-day text-center p-2"
                                        style="cursor: pointer; background-color: #ffe0e0; min-height: 80px; height: 80px; vertical-align: top; width: 14.28%; transition: all 0.3s ease;"
                                        onclick="toggleDate('{{ day_info.date_str }}', this)"
                                        onmouseover="this.style.transform='scale(1.05)'; this.style.boxShadow='0 2px 8px rgba(0,0,0,0.15)';"
                                        onmouseout="this.style.transform='scale(1)'; this.style.boxShadow='none';">
                                        <strong>{{ day_info.day }}</strong>
                                        <br>
                                        <small class="text-danger">
                                            <i class="fas fa-ban"></i> Blocked
                                            {% if day_info.reason %}
                                                <br>{{ day_info.reason|truncatewords:3 }}
                                            {% endif %}
                                        </small>
                                    </td>
                                {% else %}
                                    <!-- Available Date -->
                                    <td class="calendar-day available-day text-center p-2 {% if day_info.is_today %}border-primary border-3{% endif %}"
                                        style="cursor: pointer; background-color: #e0ffe0; min-height: 80px; height: 80px; vertical-align: top; width: 14.28%; transition: all 0.3s ease;"
                                        onclick="toggleDate('{{ day_info.date_str }}', this)"
                                        onmouseover="this.style.transform='scale(1.05)'; this.style.boxShadow='0 2px 8px rgba(0,0,0,0.15)';"
                                        onmouseout="this.style.transform='scale(1)'; this.style.boxShadow='none';">
                                        <strong>{{ day_info.day }}</strong>
                                        {% if day_info.is_today %}
                                            <br><small class="badge bg-primary">Today</small>
                                        {% else %}
                                            <br><small class="text-success"><i class="fas fa-check"></i></small>
                                        {% endif %}
                                    </td>
                                {% endif %}
                            {% else %}
                                <!-- Empty Cell -->
                                <td class="calendar-day empty-day" style="background-color: #fafafa; min-height: 80px; height: 80px; width: 14.28%;"></td>
                            {% endif %}
                        {% endfor %}
                    </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
</div>

<script>
function toggleDate(dateStr, element) {
    // Ask for reason when blocking
    let reason = '';
    const isBlocked = element.classList.contains('blocked-day');
    
    if (!isBlocked) {
        reason = prompt('Enter reason for blocking this date (optional):');
        if (reason === null) return; // User cancelled
    } else {
        if (!confirm('Unblock this date and make it available for booking?')) {
            return;
        }
    }
    
    // Get CSRF token
    const csrfToken = document.querySelector('[name=csrfmiddlewaretoken]')?.value || '{{ csrf_token }}';
    
    // Create form data
    const formData = new FormData();
    formData.append('date', dateStr);
    formData.append('reason', reason);
    formData.append('csrfmiddlewaretoken', csrfToken);
    
    // Send AJAX request
    fetch('{% url "bookings_v2:htmx_toggle_blocked_date" %}', {
        method: 'POST',
        headers: {
            'X-CSRFToken': csrfToken
        },
        body: formData
    })
    .then(response => response.json())
    .then(data => {
        const dayNum = element.querySelector('strong').textContent;
        
        if (data.status === 'blocked') {
            // Update UI to show blocked
            element.className = 'calendar-day blocked-day text-center p-2';
            element.style.cssText = 'cursor: pointer; background-color: #ffe0e0; min-height: 80px; vertical-align: top; transition: all 0.3s ease;';
            element.innerHTML = `<strong>${dayNum}</strong><br><small class="text-danger"><i class="fas fa-ban"></i> Blocked${reason ? '<br>' + reason.substring(0, 20) : ''}</small>`;
        } else if (data.status === 'unblocked') {
            // Update UI to show available
            element.className = 'calendar-day available-day text-center p-2';
            element.style.cssText = 'cursor: pointer; background-color: #e0ffe0; min-height: 80px; vertical-align: top; transition: all 0.3s ease;';
            element.innerHTML = `<strong>${dayNum}</strong><br><small class="text-success"><i class="fas fa-check"></i></small>`;
        }
        
        // Show message (optional - could use toast instead)
        console.log(data.message);
        
        // Trigger refresh of blocked dates list if it exists
        if (typeof htmx !== 'undefined') {
            htmx.trigger('#blockedDatesList', 'refreshBlockedDates');
        }
    })
    .catch(error => {
        console.error('Error:', error);
        alert('An error occurred while updating the date');
    });
}
</script>

