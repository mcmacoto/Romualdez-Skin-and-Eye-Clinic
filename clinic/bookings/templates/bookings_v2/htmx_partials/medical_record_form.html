<!-- HTMX Partial: Medical Record Edit Form -->
{% if just_created %}
<div class="alert alert-success alert-dismissible fade show" role="alert">
    <i class="fas fa-check-circle me-2"></i>
    <strong>Medical record created successfully!</strong> You can now add prescriptions and medical images.
    <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
</div>
{% endif %}

<form hx-post="{% url 'bookings_v2:htmx_medical_record_update' record.id %}{% if patient_id %}?patient_id={{ patient_id }}{% endif %}" 
      hx-target="{% if patient_id %}#patientRecordsModalBody{% else %}#medicalRecordsModalBody{% endif %}" 
      hx-swap="innerHTML"
      class="needs-validation" 
      novalidate>
    {% csrf_token %}
    
    <div class="modal-header-info mb-3">
        <h6 class="text-primary mb-2">
            <i class="fas fa-user me-2"></i>Patient: {{ record.patient.user.get_full_name }}
        </h6>
        <small class="text-muted">Record ID: #{{ record.id }}</small>
    </div>

    <div class="row">
        <!-- Visit Date -->
        <div class="col-md-6 mb-3">
            <label for="visit_date" class="form-label">
                <i class="fas fa-calendar me-1"></i>Visit Date <span class="text-danger">*</span>
            </label>
            <input 
                type="date" 
                class="form-control" 
                id="visit_date" 
                name="visit_date" 
                value="{{ record.visit_date|date:'Y-m-d' }}"
                required
            >
        </div>

        <!-- Visit Time -->
        <div class="col-md-6 mb-3">
            <label for="visit_time" class="form-label">
                <i class="fas fa-clock me-1"></i>Visit Time
            </label>
            <input 
                type="time" 
                class="form-control" 
                id="visit_time" 
                name="visit_time" 
                value="{{ record.visit_date|date:'H:i' }}"
            >
        </div>
    </div>

    <!-- Chief Complaint -->
    <div class="mb-3">
        <label for="chief_complaint" class="form-label">
            <i class="fas fa-comment-medical me-1"></i>Chief Complaint <span class="text-danger">*</span>
        </label>
        <textarea 
            class="form-control" 
            id="chief_complaint" 
            name="chief_complaint" 
            rows="2"
            placeholder="Patient's main concern or reason for visit"
            required
        >{{ record.chief_complaint }}</textarea>
    </div>

    <!-- Symptoms -->
    <div class="mb-3">
        <label for="symptoms" class="form-label">
            <i class="fas fa-stethoscope me-1"></i>Symptoms
        </label>
        <textarea 
            class="form-control" 
            id="symptoms" 
            name="symptoms" 
            rows="2"
            placeholder="Observed symptoms (optional)"
        >{{ record.symptoms|default:'' }}</textarea>
    </div>

    <!-- Diagnosis -->
    <div class="mb-3">
        <label for="diagnosis" class="form-label">
            <i class="fas fa-diagnoses me-1"></i>Diagnosis <span class="text-danger">*</span>
        </label>
        <textarea 
            class="form-control" 
            id="diagnosis" 
            name="diagnosis" 
            rows="3"
            placeholder="Enter diagnosis details..."
            required
        >{{ record.diagnosis }}</textarea>
    </div>

    <!-- Treatment Plan -->
    <div class="mb-3">
        <label for="treatment_plan" class="form-label">
            <i class="fas fa-procedures me-1"></i>Treatment Plan <span class="text-danger">*</span>
        </label>
        <textarea 
            class="form-control" 
            id="treatment_plan" 
            name="treatment_plan" 
            rows="3"
            placeholder="Enter treatment plan..."
            required
        >{{ record.treatment_plan }}</textarea>
    </div>

    <!-- Vital Signs -->
    <div class="card mb-3">
        <div class="card-header bg-light">
            <h6 class="mb-0"><i class="fas fa-heartbeat me-2"></i>Vital Signs (Optional)</h6>
        </div>
        <div class="card-body">
            <div class="row">
                <!-- Temperature -->
                <div class="col-md-4 mb-3">
                    <label for="temperature" class="form-label">
                        <i class="fas fa-thermometer-half me-1"></i>Temperature (Â°C)
                    </label>
                    <input 
                        type="number" 
                        step="0.1"
                        class="form-control" 
                        id="temperature" 
                        name="temperature" 
                        value="{{ record.temperature|default:'' }}"
                        placeholder="e.g., 36.5"
                    >
                </div>

                <!-- Blood Pressure -->
                <div class="col-md-4 mb-3">
                    <label for="blood_pressure" class="form-label">
                        <i class="fas fa-heartbeat me-1"></i>Blood Pressure
                    </label>
                    <input 
                        type="text" 
                        class="form-control" 
                        id="blood_pressure" 
                        name="blood_pressure" 
                        value="{{ record.blood_pressure|default:'' }}"
                        placeholder="e.g., 120/80"
                    >
                </div>

                <!-- Heart Rate -->
                <div class="col-md-4 mb-3">
                    <label for="heart_rate" class="form-label">
                        <i class="fas fa-heartbeat me-1"></i>Heart Rate (bpm)
                    </label>
                    <input 
                        type="number" 
                        class="form-control" 
                        id="heart_rate" 
                        name="heart_rate" 
                        value="{{ record.heart_rate|default:'' }}"
                        placeholder="e.g., 72"
                    >
                </div>
            </div>

            <div class="row">
                <!-- Weight -->
                <div class="col-md-6 mb-3">
                    <label for="weight" class="form-label">
                        <i class="fas fa-weight me-1"></i>Weight (kg)
                    </label>
                    <input 
                        type="number" 
                        step="0.1"
                        class="form-control" 
                        id="weight" 
                        name="weight" 
                        value="{{ record.weight|default:'' }}"
                        placeholder="e.g., 65"
                    >
                </div>

                <!-- Height -->
                <div class="col-md-6 mb-3">
                    <label for="height" class="form-label">
                        <i class="fas fa-ruler-vertical me-1"></i>Height (cm)
                    </label>
                    <input 
                        type="number" 
                        step="0.1"
                        class="form-control" 
                        id="height" 
                        name="height" 
                        value="{{ record.height|default:'' }}"
                        placeholder="e.g., 165"
                    >
                </div>
            </div>
        </div>
    </div>

    <!-- Notes -->
    <div class="mb-3">
        <label for="notes" class="form-label">
            <i class="fas fa-sticky-note me-1"></i>Additional Notes
        </label>
        <textarea 
            class="form-control" 
            id="notes" 
            name="notes" 
            rows="2"
            placeholder="Enter any additional notes..."
        >{{ record.notes|default:'' }}</textarea>
    </div>

    <!-- Follow-up Date -->
    <div class="mb-3">
        <label for="follow_up_date" class="form-label">
            <i class="fas fa-calendar-check me-1"></i>Follow-up Date
        </label>
        <input 
            type="date" 
            class="form-control" 
            id="follow_up_date" 
            name="follow_up_date" 
            value="{% if record.follow_up_date %}{{ record.follow_up_date|date:'Y-m-d' }}{% endif %}"
        >
    </div>

    <!-- Prescriptions Management -->
    <div class="card mb-3">
        <div class="card-header bg-light d-flex justify-content-between align-items-center">
            <h6 class="mb-0"><i class="fas fa-pills me-2"></i>Prescriptions</h6>
            <button 
                type="button"
                class="btn btn-sm btn-success"
                hx-get="{% url 'bookings_v2:htmx_prescriptions' record.id %}"
                hx-target="#prescriptionsModalBody"
                hx-swap="innerHTML"
                data-bs-toggle="modal"
                data-bs-target="#prescriptionsModal"
            >
                <i class="fas fa-eye me-1"></i>Manage Prescriptions
                {% if record.prescriptions.count > 0 %}
                <span class="badge bg-white text-success ms-1">{{ record.prescriptions.count }}</span>
                {% endif %}
            </button>
        </div>
        <div class="card-body">
            {% if record.prescriptions.count > 0 %}
                <p class="mb-0 text-success">
                    <i class="fas fa-check-circle me-2"></i>
                    This record has {{ record.prescriptions.count }} prescription(s). Click "Manage Prescriptions" to view or edit.
                </p>
            {% else %}
                <p class="mb-0 text-muted">
                    <i class="fas fa-info-circle me-2"></i>
                    No prescriptions added yet. Click "Manage Prescriptions" to add one.
                </p>
            {% endif %}
        </div>
    </div>

    <!-- Medical Images Management -->
    <div class="card mb-3">
        <div class="card-header bg-light d-flex justify-content-between align-items-center">
            <h6 class="mb-0"><i class="fas fa-images me-2"></i>Medical Images</h6>
            <button 
                type="button"
                class="btn btn-sm btn-info"
                hx-get="{% url 'bookings_v2:htmx_medical_images' record.id %}"
                hx-target="#medicalImagesModalBody"
                hx-swap="innerHTML"
                data-bs-toggle="modal"
                data-bs-target="#medicalImagesModal"
            >
                <i class="fas fa-eye me-1"></i>Manage Images
                {% if record.images.count > 0 %}
                <span class="badge bg-white text-info ms-1">{{ record.images.count }}</span>
                {% endif %}
            </button>
        </div>
        <div class="card-body">
            {% if record.images.count > 0 %}
                <p class="mb-0 text-info">
                    <i class="fas fa-check-circle me-2"></i>
                    This record has {{ record.images.count }} image(s). Click "Manage Images" to view or edit.
                </p>
            {% else %}
                <p class="mb-0 text-muted">
                    <i class="fas fa-info-circle me-2"></i>
                    No images uploaded yet. Click "Manage Images" to upload one.
                </p>
            {% endif %}
        </div>
    </div>

    <!-- Form Actions -->
    <div class="d-flex justify-content-between pt-3 border-top">
        {% if patient_id %}
        <!-- Opened from patient records view - return to patient records -->
        <button 
            type="button" 
            class="btn btn-secondary"
            hx-get="{% url 'bookings_v2:htmx_patient_records' patient_id %}"
            hx-target="#patientRecordsModalBody"
            hx-swap="innerHTML"
        >
            <i class="fas fa-arrow-left me-1"></i>Cancel
        </button>
        {% else %}
        <!-- Opened from general medical records - return to list -->
        <button 
            type="button" 
            class="btn btn-secondary"
            hx-get="{% url 'bookings_v2:htmx_medical_records_list' %}"
            hx-target="#medicalRecordsModalBody"
            hx-swap="innerHTML"
        >
            <i class="fas fa-arrow-left me-1"></i>Cancel
        </button>
        {% endif %}
        <button type="submit" class="btn btn-primary">
            <i class="fas fa-save me-1"></i>Update Record
        </button>
    </div>
</form>

<style>
    .modal-header-info {
        background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
        padding: 1rem;
        border-radius: 8px;
    }
</style>
