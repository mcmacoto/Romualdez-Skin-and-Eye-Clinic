{% extends 'bookings_v2/base_v2.html' %}

{% block title %}Book Appointment - V2{% endblock %}

{% block content %}
<div class="container py-5">
    <div class="row justify-content-center">
        <div class="col-lg-8">
            <!-- Professional Hero Section -->
            <div class="text-center mb-5" data-aos="fade-up">
                <span class="badge badge-professional bg-primary text-white mb-3">Book Appointment</span>
                <h1 class="display-5 fw-bold mb-3">Schedule Your Visit</h1>
                <p class="text-muted lead">Fill out the form below and we'll confirm your appointment within 24 hours</p>
            </div>
            
            <!-- Professional Booking Form Card -->
            <div class="card border-0 shadow-sm card-hover-lift" data-aos="fade-up" data-aos-delay="100">
                <div class="card-header bg-gradient text-white border-0" style="background: linear-gradient(135deg, var(--primary-color) 0%, var(--primary-dark) 100%);">
                    <div class="d-flex align-items-center">
                        <i class="fas fa-calendar-check fa-2x me-3"></i>
                        <div>
                            <h3 class="mb-0">Book an Appointment</h3>
                            <small class="opacity-90">Complete the form to schedule your visit</small>
                        </div>
                    </div>
                </div>
                <div class="card-body p-4 p-md-5" id="booking-form-container">
                    {% if user.is_authenticated %}
                    <form 
                        hx-post="/admin/htmx/submit-booking/" 
                        hx-target="#booking-form-container"
                        hx-swap="innerHTML"
                        hx-indicator="#loading-spinner"
                        x-data="bookingForm()"
                        @submit="validateForm($event)"
                    >
                        {% csrf_token %}
                        
                        <!-- Professional Service Selection -->
                        <div class="mb-4">
                            <label class="form-label fw-bold text-muted small mb-2">
                                <i class="fas fa-concierge-bell text-primary me-1"></i> SELECT SERVICE *
                            </label>
                            <select 
                                class="form-select form-select-lg form-control-professional" 
                                name="service"
                                x-model="selectedService" 
                                @change="loadTimeSlots()"
                                required
                            >
                                <option value="">Choose a service...</option>
                                {% for service in services %}
                                <option value="{{ service.id }}" data-price="{{ service.price }}">
                                    {{ service.name }} - â‚±{{ service.price|floatformat:0 }}
                                </option>
                                {% endfor %}
                            </select>
                            <div class="invalid-feedback d-block text-danger small mt-1" x-show="errors.service" x-text="errors.service"></div>
                        </div>

                        <!-- Professional Patient Information Section -->
                        <div class="mb-4 mt-5">
                            <span class="badge badge-professional bg-primary text-white mb-2">Step 1</span>
                            <h5 class="fw-bold mb-3">
                                <i class="fas fa-user-circle text-primary me-2"></i> Patient Information
                            </h5>
                        </div>
                        
                        <!-- Professional Patient Name -->
                        <div class="mb-4">
                            <label class="form-label fw-medium mb-2">
                                <i class="fas fa-user text-primary me-1"></i> Full Name *
                            </label>
                            <input 
                                type="text" 
                                class="form-control form-control-lg form-control-professional" 
                                name="patient_name"
                                x-model="patientName"
                                @blur="validateField('patient_name')"
                                placeholder="Enter your full name"
                                required
                            >
                            <div class="invalid-feedback d-block text-danger small mt-1" x-show="errors.patient_name" x-text="errors.patient_name"></div>
                        </div>

                        <!-- Professional Email -->
                        <div class="mb-4">
                            <label class="form-label fw-medium mb-2">
                                <i class="fas fa-envelope text-primary me-1"></i> Email Address *
                            </label>
                            <input 
                                type="email" 
                                class="form-control form-control-lg form-control-professional" 
                                name="patient_email"
                                x-model="patientEmail"
                                @blur="validateField('patient_email')"
                                placeholder="your.email@example.com"
                                required
                            >
                            <div class="invalid-feedback d-block text-danger small mt-1" x-show="errors.patient_email" x-text="errors.patient_email"></div>
                        </div>

                        <!-- Professional Phone -->
                        <div class="mb-4">
                            <label class="form-label fw-medium mb-2">
                                <i class="fas fa-phone text-primary me-1"></i> Phone Number *
                            </label>
                            <input 
                                type="tel" 
                                class="form-control form-control-lg form-control-professional" 
                                name="patient_phone"
                                x-model="patientPhone"
                                @blur="validateField('patient_phone')"
                                placeholder="+63 9XX XXX XXXX"
                                pattern="[+]?[0-9]{10,15}"
                                required
                            >
                            <small class="form-text text-muted d-flex align-items-center mt-2">
                                <i class="fas fa-info-circle me-1"></i> Format: +63XXXXXXXXXX or 09XXXXXXXXX
                            </small>
                            <div class="invalid-feedback d-block text-danger small mt-1" x-show="errors.patient_phone" x-text="errors.patient_phone"></div>
                        </div>

                        <!-- Professional Appointment Details Section -->
                        <div class="mb-4 mt-5">
                            <span class="badge badge-professional bg-primary text-white mb-2">Step 2</span>
                            <h5 class="fw-bold mb-3">
                                <i class="fas fa-calendar-alt text-primary me-2"></i> Appointment Details
                            </h5>
                        </div>

                        <!-- Professional Date Selection -->
                        <div class="mb-4">
                            <label class="form-label fw-medium mb-2">
                                <i class="fas fa-calendar text-primary me-1"></i> Preferred Date *
                            </label>
                            <input 
                                type="date" 
                                class="form-control form-control-lg form-control-professional" 
                                name="date"
                                x-model="selectedDate"
                                :min="minDate"
                                @change="loadTimeSlots()"
                                required
                            >
                            <small class="form-text text-muted d-flex align-items-center mt-2">
                                <i class="fas fa-info-circle me-1"></i> Please select a date at least 1 day in advance
                            </small>
                        </div>

                        <!-- Professional Time Selection with HTMX -->
                        <div class="mb-4">
                            <label class="form-label fw-medium mb-2">
                                <i class="fas fa-clock text-primary me-1"></i> Preferred Time *
                            </label>
                            <div id="time-slots-container">
                                <select 
                                    class="form-select form-select-lg form-control-professional" 
                                    name="time" 
                                    required 
                                    disabled
                                    hx-get="/admin/htmx/time-slots/"
                                    hx-trigger="loadTimeSlots from:body"
                                    hx-include="[name='service'], [name='date']"
                                    hx-target="#time-slots-container"
                                    hx-swap="innerHTML"
                                    hx-indicator="#time-loading"
                                >
                                    <option value="">Select service and date first...</option>
                                </select>
                            </div>
                            <div id="time-loading" class="htmx-indicator">
                                <div class="d-flex align-items-center text-muted small mt-2">
                                    <div class="spinner-professional me-2" style="width: 16px; height: 16px; border-width: 2px;"></div>
                                    <span>Loading available time slots...</span>
                                </div>
                            </div>
                        </div>

                        <!-- Professional Notes -->
                        <div class="mb-4">
                            <label class="form-label fw-medium mb-2">
                                <i class="fas fa-sticky-note text-primary me-1"></i> Additional Notes (Optional)
                            </label>
                            <textarea 
                                class="form-control form-control-professional" 
                                name="notes" 
                                rows="4"
                                x-model="notes"
                                placeholder="Any special requests or information we should know?"
                            ></textarea>
                            <small class="form-text text-muted d-flex align-items-center mt-2">
                                <i class="fas fa-lightbulb me-1"></i> Let us know about any allergies, medications, or special needs
                            </small>
                        </div>

                        <!-- Professional Loading Spinner -->
                        <div id="loading-spinner" class="htmx-indicator">
                            <div class="loading-overlay">
                                <div class="text-center py-5">
                                    <div class="spinner-professional mb-3"></div>
                                    <p class="text-muted fw-medium">Processing your booking...</p>
                                    <small class="text-muted">Please wait while we confirm availability</small>
                                </div>
                            </div>
                        </div>

                        <!-- Professional Submit Button -->
                        <div class="d-grid gap-3 mt-5 pt-4 border-top">
                            <button 
                                type="submit" 
                                class="btn btn-primary btn-lg px-5 py-3 hover-scale shadow-sm"
                                :disabled="!isFormValid"
                                :class="{'opacity-50': !isFormValid}"
                            >
                                <i class="fas fa-check-circle me-2"></i> Confirm Appointment
                            </button>
                            <a href="/admin/" class="btn btn-outline-secondary btn-lg hover-scale">
                                <i class="fas fa-arrow-left me-2"></i> Back to Home
                            </a>
                        </div>
                    </form>
                    {% else %}
                    <!-- Professional Guest User Restriction Message -->
                    <div class="alert alert-professional alert-warning border-0 shadow-sm" role="alert">
                        <div class="d-flex align-items-start">
                            <div class="flex-shrink-0">
                                <div class="d-inline-flex align-items-center justify-content-center bg-warning bg-opacity-10 rounded-circle" style="width: 60px; height: 60px;">
                                    <i class="fas fa-exclamation-triangle fa-2x text-warning"></i>
                                </div>
                            </div>
                            <div class="flex-grow-1 ms-3">
                                <h5 class="alert-heading fw-bold mb-3">
                                    <i class="fas fa-lock me-2"></i>Account Required
                                </h5>
                                <p class="mb-3 lh-base">
                                    You must have an account to book online. Please visit the clinic in person to create an account, or contact us for assistance.
                                </p>
                                <hr class="my-3">
                                <div class="row g-3 small">
                                    <div class="col-md-12">
                                        <p class="mb-2"><i class="fas fa-map-marker-alt text-warning me-2"></i><strong>Clinic Address:</strong></p>
                                        <p class="mb-3 ms-4">140 Juan Luna St., Koronadal City<br>South Cotabato 9506, Philippines</p>
                                    </div>
                                    <div class="col-md-6">
                                        <p class="mb-0"><i class="fas fa-phone text-warning me-2"></i><strong>Contact:</strong></p>
                                        <p class="mb-0 ms-4">+63 976 152 1752</p>
                                    </div>
                                    <div class="col-md-6">
                                        <p class="mb-0"><i class="fas fa-clock text-warning me-2"></i><strong>Hours:</strong></p>
                                        <p class="mb-0 ms-4">Monday - Saturday<br>9:00 AM - 5:00 PM</p>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="d-grid gap-3 mt-4">
                        <a href="/admin/contact/" class="btn btn-warning btn-lg hover-scale shadow-sm">
                            <i class="fas fa-phone me-2"></i> Contact Us
                        </a>
                        <a href="/admin/login/" class="btn btn-outline-primary btn-lg hover-scale">
                            <i class="fas fa-sign-in-alt me-2"></i> Already have an account? Login
                        </a>
                    </div>
                    {% endif %}
                </div>
            </div>

            <!-- Professional Info Alert -->
            <div class="card border-0 shadow-sm mt-4" data-aos="fade-up" data-aos-delay="200">
                <div class="card-body bg-light">
                    <div class="d-flex align-items-start">
                        <div class="flex-shrink-0">
                            <i class="fas fa-info-circle fa-2x text-info"></i>
                        </div>
                        <div class="flex-grow-1 ms-3">
                            <h6 class="fw-bold mb-2">Important Information</h6>
                            <ul class="mb-0 ps-3">
                                <li class="mb-1"><strong>Clinic Hours:</strong> Monday to Saturday, 9:00 AM - 5:00 PM</li>
                                <li class="mb-1"><strong>Confirmation:</strong> We'll confirm your appointment within 24 hours</li>
                                <li class="mb-0"><strong>Cancellation:</strong> Please notify us at least 24 hours in advance</li>
                            </ul>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<style>
.htmx-indicator {
    display: none;
}
.htmx-request .htmx-indicator {
    display: inline-block;
}
.htmx-request.htmx-indicator {
    display: inline-block;
}
.invalid-feedback {
    display: none;
}
.invalid-feedback[x-show="true"] {
    display: block;
}
</style>

<script>
function bookingForm() {
    return {
        selectedService: '',
        selectedDate: '',
        patientName: '',
        patientEmail: '',
        patientPhone: '',
        notes: '',
        errors: {
            service: '',
            patient_name: '',
            patient_email: '',
            patient_phone: ''
        },
        minDate: new Date(Date.now() + 86400000).toISOString().split('T')[0], // Tomorrow
        
        get isFormValid() {
            return this.selectedService && 
                   this.selectedDate && 
                   this.patientName.length > 2 && 
                   this.patientEmail.includes('@') &&
                   this.patientPhone.length >= 10;
        },
        
        validateField(field) {
            switch(field) {
                case 'patient_name':
                    if (this.patientName.length < 3) {
                        this.errors.patient_name = 'Name must be at least 3 characters';
                    } else {
                        this.errors.patient_name = '';
                    }
                    break;
                case 'patient_email':
                    const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
                    if (!emailRegex.test(this.patientEmail)) {
                        this.errors.patient_email = 'Please enter a valid email address';
                    } else {
                        this.errors.patient_email = '';
                    }
                    break;
                case 'patient_phone':
                    const phoneRegex = /^[+]?[0-9]{10,15}$/;
                    if (!phoneRegex.test(this.patientPhone.replace(/\s/g, ''))) {
                        this.errors.patient_phone = 'Please enter a valid phone number';
                    } else {
                        this.errors.patient_phone = '';
                    }
                    break;
            }
        },
        
        validateForm(event) {
            if (!this.selectedService) {
                this.errors.service = 'Please select a service';
                event.preventDefault();
                return false;
            }
            this.validateField('patient_name');
            this.validateField('patient_email');
            this.validateField('patient_phone');
            
            // Check if there are any errors
            const hasErrors = Object.values(this.errors).some(error => error !== '');
            if (hasErrors) {
                event.preventDefault();
                return false;
            }
        },
        
        loadTimeSlots() {
            const selectElement = document.querySelector('#time-slots-container select');
            if (!selectElement) return;
            
            if (this.selectedService && this.selectedDate) {
                // Trigger HTMX to load time slots on the select element
                htmx.trigger(selectElement, 'loadTimeSlots');
            } else {
                // Reset and disable time select if date or service is cleared
                selectElement.disabled = true;
                selectElement.innerHTML = '<option value="">Select service and date first...</option>';
                selectElement.value = '';
            }
        }
    }
}
</script>
{% endblock %}
