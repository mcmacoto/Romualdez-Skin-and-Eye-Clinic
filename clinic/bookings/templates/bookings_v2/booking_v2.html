{% extends 'bookings_v2/base_v2.html' %}

{% block title %}Book Appointment - V2{% endblock %}

{% block content %}
<div class="container py-5">
    <div class="row justify-content-center">
        <div class="col-lg-8">
            <!-- Booking Form Card -->
            <div class="card shadow">
                <div class="card-header bg-primary text-white">
                    <h3 class="mb-0"><i class="fas fa-calendar-check"></i> Book an Appointment</h3>
                </div>
                <div class="card-body" id="booking-form-container">
                    <form 
                        hx-post="/v2/htmx/submit-booking/" 
                        hx-target="#booking-form-container"
                        hx-swap="innerHTML"
                        hx-indicator="#loading-spinner"
                        x-data="bookingForm()"
                        @submit="validateForm($event)"
                    >
                        {% csrf_token %}
                        
                        <!-- Service Selection -->
                        <div class="mb-3">
                            <label class="form-label fw-bold">
                                <i class="fas fa-concierge-bell text-primary"></i> Select Service *
                            </label>
                            <select 
                                class="form-select" 
                                name="service"
                                x-model="selectedService" 
                                @change="loadTimeSlots()"
                                required
                            >
                                <option value="">Choose a service...</option>
                                {% for service in services %}
                                <option value="{{ service.id }}" data-price="{{ service.price }}">
                                    {{ service.name }} - â‚±{{ service.price }}
                                </option>
                                {% endfor %}
                            </select>
                            <div class="invalid-feedback" x-show="errors.service" x-text="errors.service"></div>
                        </div>

                        <!-- Patient Information Section -->
                        <h5 class="mb-3 mt-4"><i class="fas fa-user-circle"></i> Patient Information</h5>
                        
                        <!-- Patient Name -->
                        <div class="mb-3">
                            <label class="form-label fw-bold">Full Name *</label>
                            <input 
                                type="text" 
                                class="form-control" 
                                name="patient_name"
                                x-model="patientName"
                                @blur="validateField('patient_name')"
                                placeholder="Enter your full name"
                                required
                            >
                            <div class="invalid-feedback" x-show="errors.patient_name" x-text="errors.patient_name"></div>
                        </div>

                        <!-- Email -->
                        <div class="mb-3">
                            <label class="form-label fw-bold">Email Address *</label>
                            <input 
                                type="email" 
                                class="form-control" 
                                name="patient_email"
                                x-model="patientEmail"
                                @blur="validateField('patient_email')"
                                placeholder="your.email@example.com"
                                required
                            >
                            <div class="invalid-feedback" x-show="errors.patient_email" x-text="errors.patient_email"></div>
                        </div>

                        <!-- Phone -->
                        <div class="mb-3">
                            <label class="form-label fw-bold">Phone Number *</label>
                            <input 
                                type="tel" 
                                class="form-control" 
                                name="patient_phone"
                                x-model="patientPhone"
                                @blur="validateField('patient_phone')"
                                placeholder="+63 9XX XXX XXXX"
                                pattern="[+]?[0-9]{10,15}"
                                required
                            >
                            <small class="form-text text-muted">Format: +63XXXXXXXXXX or 09XXXXXXXXX</small>
                            <div class="invalid-feedback" x-show="errors.patient_phone" x-text="errors.patient_phone"></div>
                        </div>

                        <!-- Appointment Details Section -->
                        <h5 class="mb-3 mt-4"><i class="fas fa-calendar-alt"></i> Appointment Details</h5>

                        <!-- Date Selection -->
                        <div class="mb-3">
                            <label class="form-label fw-bold">Preferred Date *</label>
                            <input 
                                type="date" 
                                class="form-control" 
                                name="date"
                                x-model="selectedDate"
                                :min="minDate"
                                @change="loadTimeSlots()"
                                required
                            >
                            <small class="form-text text-muted">Please select a date at least 1 day in advance</small>
                        </div>

                        <!-- Time Selection with HTMX -->
                        <div class="mb-3">
                            <label class="form-label fw-bold">Preferred Time *</label>
                            <div id="time-slots-container">
                                <select 
                                    class="form-select" 
                                    name="time" 
                                    required 
                                    disabled
                                    hx-get="/v2/htmx/time-slots/"
                                    hx-trigger="loadTimeSlots from:body"
                                    hx-include="[name='service'], [name='date']"
                                    hx-target="#time-slots-container"
                                    hx-swap="innerHTML"
                                    hx-indicator="#time-loading"
                                >
                                    <option value="">Select service and date first...</option>
                                </select>
                            </div>
                            <div id="time-loading" class="htmx-indicator">
                                <small class="text-muted">
                                    <i class="fas fa-spinner fa-spin"></i> Loading available time slots...
                                </small>
                            </div>
                        </div>

                        <!-- Notes -->
                        <div class="mb-3">
                            <label class="form-label fw-bold">Additional Notes (Optional)</label>
                            <textarea 
                                class="form-control" 
                                name="notes" 
                                rows="3"
                                x-model="notes"
                                placeholder="Any special requests or information we should know?"
                            ></textarea>
                        </div>

                        <!-- Loading Spinner -->
                        <div id="loading-spinner" class="htmx-indicator text-center my-3">
                            <div class="spinner-border text-primary" role="status">
                                <span class="visually-hidden">Loading...</span>
                            </div>
                            <p class="mt-2 text-muted">Processing your booking...</p>
                        </div>

                        <!-- Submit Button -->
                        <div class="d-grid gap-2 mt-4">
                            <button 
                                type="submit" 
                                class="btn btn-primary btn-lg"
                                :disabled="!isFormValid"
                            >
                                <i class="fas fa-check-circle"></i> Book Appointment
                            </button>
                            <a href="/v2/" class="btn btn-outline-secondary">
                                <i class="fas fa-arrow-left"></i> Back to Home
                            </a>
                        </div>
                    </form>
                </div>
            </div>

            <!-- Info Alert -->
            <div class="alert alert-info mt-4" role="alert">
                <i class="fas fa-info-circle"></i> <strong>Clinic Hours:</strong> Monday to Saturday, 9:00 AM - 5:00 PM. 
                We'll confirm your appointment within 24 hours.
            </div>
        </div>
    </div>
</div>

<style>
.htmx-indicator {
    display: none;
}
.htmx-request .htmx-indicator {
    display: inline-block;
}
.htmx-request.htmx-indicator {
    display: inline-block;
}
.invalid-feedback {
    display: none;
}
.invalid-feedback[x-show="true"] {
    display: block;
}
</style>

<script>
function bookingForm() {
    return {
        selectedService: '',
        selectedDate: '',
        patientName: '',
        patientEmail: '',
        patientPhone: '',
        notes: '',
        errors: {
            service: '',
            patient_name: '',
            patient_email: '',
            patient_phone: ''
        },
        minDate: new Date(Date.now() + 86400000).toISOString().split('T')[0], // Tomorrow
        
        get isFormValid() {
            return this.selectedService && 
                   this.selectedDate && 
                   this.patientName.length > 2 && 
                   this.patientEmail.includes('@') &&
                   this.patientPhone.length >= 10;
        },
        
        validateField(field) {
            switch(field) {
                case 'patient_name':
                    if (this.patientName.length < 3) {
                        this.errors.patient_name = 'Name must be at least 3 characters';
                    } else {
                        this.errors.patient_name = '';
                    }
                    break;
                case 'patient_email':
                    const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
                    if (!emailRegex.test(this.patientEmail)) {
                        this.errors.patient_email = 'Please enter a valid email address';
                    } else {
                        this.errors.patient_email = '';
                    }
                    break;
                case 'patient_phone':
                    const phoneRegex = /^[+]?[0-9]{10,15}$/;
                    if (!phoneRegex.test(this.patientPhone.replace(/\s/g, ''))) {
                        this.errors.patient_phone = 'Please enter a valid phone number';
                    } else {
                        this.errors.patient_phone = '';
                    }
                    break;
            }
        },
        
        validateForm(event) {
            if (!this.selectedService) {
                this.errors.service = 'Please select a service';
                event.preventDefault();
                return false;
            }
            this.validateField('patient_name');
            this.validateField('patient_email');
            this.validateField('patient_phone');
            
            // Check if there are any errors
            const hasErrors = Object.values(this.errors).some(error => error !== '');
            if (hasErrors) {
                event.preventDefault();
                return false;
            }
        },
        
        loadTimeSlots() {
            if (this.selectedService && this.selectedDate) {
                // Trigger HTMX to load time slots on the select element
                const selectElement = document.querySelector('#time-slots-container select');
                if (selectElement) {
                    htmx.trigger(selectElement, 'loadTimeSlots');
                }
            }
        }
    }
}
</script>
{% endblock %}
