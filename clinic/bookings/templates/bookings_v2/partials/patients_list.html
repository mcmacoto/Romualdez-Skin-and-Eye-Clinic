<!-- HTMX Partial: Patients List -->
<!-- Search Bar -->
<div class="search-bar mb-3">
    <div class="input-group">
        <span class="input-group-text bg-primary text-white border-0">
            <i class="fas fa-search"></i>
        </span>
        <input 
            type="text" 
            class="form-control form-control-professional border-0 shadow-none" 
            placeholder="Search by name, email, or phone..." 
            name="search"
            hx-get="{% url 'bookings_v2:htmx_patients_list' %}"
            hx-trigger="keyup changed delay:500ms"
            hx-target="#patientsModalBody"
            hx-swap="innerHTML"
            hx-include="this"
        >
    </div>
</div>

{% if patients %}
<div class="table-responsive">
    <table class="table table-hover align-middle">
        <thead class="table-light">
            <tr>
                <th class="sortable {% if sort_by == 'name' %}sort-{{ sort_order }}{% endif %}"
                    hx-get="{% url 'bookings_v2:htmx_patients_list' %}?sort=name&order={% if sort_by == 'name' and sort_order == 'asc' %}desc{% else %}asc{% endif %}"
                    hx-target="#patientsModalBody"
                    hx-swap="innerHTML"
                    hx-include="[name='search']">
                    <i class="fas fa-user me-2"></i>Name
                </th>
                <th class="sortable {% if sort_by == 'email' %}sort-{{ sort_order }}{% endif %}"
                    hx-get="{% url 'bookings_v2:htmx_patients_list' %}?sort=email&order={% if sort_by == 'email' and sort_order == 'asc' %}desc{% else %}asc{% endif %}"
                    hx-target="#patientsModalBody"
                    hx-swap="innerHTML"
                    hx-include="[name='search']">
                    <i class="fas fa-envelope me-2"></i>Email
                </th>
                <th class="sortable {% if sort_by == 'phone' %}sort-{{ sort_order }}{% endif %}"
                    hx-get="{% url 'bookings_v2:htmx_patients_list' %}?sort=phone&order={% if sort_by == 'phone' and sort_order == 'asc' %}desc{% else %}asc{% endif %}"
                    hx-target="#patientsModalBody"
                    hx-swap="innerHTML"
                    hx-include="[name='search']">
                    <i class="fas fa-phone me-2"></i>Phone
                </th>
                <th class="sortable {% if sort_by == 'gender' %}sort-{{ sort_order }}{% endif %}"
                    hx-get="{% url 'bookings_v2:htmx_patients_list' %}?sort=gender&order={% if sort_by == 'gender' and sort_order == 'asc' %}desc{% else %}asc{% endif %}"
                    hx-target="#patientsModalBody"
                    hx-swap="innerHTML"
                    hx-include="[name='search']">
                    <i class="fas fa-venus-mars me-2"></i>Gender
                </th>
                <th class="sortable {% if sort_by == 'dob' %}sort-{{ sort_order }}{% endif %}"
                    hx-get="{% url 'bookings_v2:htmx_patients_list' %}?sort=dob&order={% if sort_by == 'dob' and sort_order == 'asc' %}desc{% else %}asc{% endif %}"
                    hx-target="#patientsModalBody"
                    hx-swap="innerHTML"
                    hx-include="[name='search']">
                    <i class="fas fa-birthday-cake me-2"></i>DOB
                </th>
                <th class="text-center"><i class="fas fa-file-medical me-2"></i>Records</th>
                <th class="text-center"><i class="fas fa-cog me-2"></i>Actions</th>
            </tr>
        </thead>
        <tbody>
            {% for patient in patients %}
            <tr id="patient-row-{{ patient.id }}">
                <td>
                    <div>
                        <strong>{{ patient.user.get_full_name|default:patient.user.username }}</strong>
                    </div>
                </td>
                <td>
                    <small>{{ patient.user.email }}</small>
                </td>
                <td>
                    <span class="badge bg-light text-dark">
                        <i class="fas fa-phone"></i> {{ patient.phone|default:"N/A" }}
                    </span>
                </td>
                <td>
                    {% if patient.gender == 'M' %}
                        <i class="fas fa-mars text-primary"></i> Male
                    {% elif patient.gender == 'F' %}
                        <i class="fas fa-venus text-danger"></i> Female
                    {% else %}
                        <i class="fas fa-genderless text-secondary"></i> Other
                    {% endif %}
                </td>
                <td>
                    {% if patient.date_of_birth %}
                        {{ patient.date_of_birth|date:"M d, Y" }}
                    {% else %}
                        <span class="text-muted">N/A</span>
                    {% endif %}
                </td>
                <td class="text-center">
                    <button 
                        class="btn btn-sm btn-info"
                        hx-get="{% url 'bookings_v2:htmx_patient_records' patient.id %}"
                        hx-target="#patientRecordsModalBody"
                        hx-swap="innerHTML"
                        data-bs-toggle="modal"
                        data-bs-target="#patientRecordsModal"
                        title="View Medical Records"
                    >
                        <i class="fas fa-file-medical"></i>
                        <span class="badge bg-white text-info ms-1">{{ patient.medical_records.count }}</span>
                    </button>
                </td>
                <td class="text-center">
                    <div class="btn-group" role="group">
                        <button 
                            class="btn btn-sm btn-primary"
                            hx-get="{% url 'bookings_v2:htmx_patient_detail' patient.id %}"
                            hx-target="#patientsModalBody"
                            hx-swap="innerHTML"
                            title="View Profile"
                        >
                            <i class="fas fa-eye"></i>
                        </button>
                        <button 
                            class="btn btn-sm btn-warning"
                            hx-get="{% url 'bookings_v2:htmx_patient_edit_form' patient.id %}"
                            hx-target="#patientsModalBody"
                            hx-swap="innerHTML"
                            title="Edit Patient"
                        >
                            <i class="fas fa-edit"></i>
                        </button>
                        <button 
                            class="btn btn-sm btn-danger"
                            hx-delete="{% url 'bookings_v2:htmx_delete_patient' patient.id %}"
                            hx-target="#patient-row-{{ patient.id }}"
                            hx-swap="outerHTML swap:1s"
                            hx-confirm="⚠️ WARNING: This will permanently delete {{ patient.user.get_full_name|default:patient.user.username }} and ALL associated records (appointments, medical records, billing). Type the patient's name to confirm."
                            title="Delete Patient"
                        >
                            <i class="fas fa-trash"></i>
                        </button>
                    </div>
                </td>
            </tr>
            {% endfor %}
        </tbody>
    </table>
</div>
{% else %}
<div class="alert alert-info text-center my-4">
    <i class="fas fa-info-circle fa-2x mb-3"></i>
    <h5>No Patients Found</h5>
    <p class="mb-0">There are no patient records in the system yet.</p>
</div>
{% endif %}
