<!-- HTMX Partial: Medical Records List -->
<!-- Header with Search and New Record Button -->
<div class="d-flex justify-content-between align-items-center mb-3">
    <div class="flex-grow-1 me-2">
        <div class="input-group">
            <span class="input-group-text bg-white">
                <i class="fas fa-search text-muted"></i>
            </span>
            <input 
                type="text" 
                class="form-control" 
                placeholder="Search by patient name, diagnosis, or complaint..." 
                name="search"
                hx-get="{% url 'bookings_v2:htmx_medical_records_list' %}"
                hx-trigger="keyup changed delay:500ms"
                hx-target="#medicalRecordsModalBody"
                hx-swap="innerHTML"
                hx-include="this"
            >
        </div>
    </div>
    <button 
        type="button" 
        class="btn btn-success"
        hx-get="{% url 'bookings_v2:htmx_medical_record_create_form' %}"
        hx-target="#medicalRecordsModalBody"
        hx-swap="innerHTML"
    >
        <i class="fas fa-plus me-2"></i>New Record
    </button>
</div>

{% if records %}
<div class="table-responsive">
    <table class="table table-hover align-middle">
        <thead class="table-light">
            <tr>
                <th><i class="fas fa-user me-2"></i>Patient</th>
                <th><i class="fas fa-calendar me-2"></i>Visit Date</th>
                <th><i class="fas fa-notes-medical me-2"></i>Chief Complaint</th>
                <th><i class="fas fa-diagnoses me-2"></i>Diagnosis</th>
                <th><i class="fas fa-pills me-2"></i>Prescriptions</th>
                <th class="text-center"><i class="fas fa-images me-2"></i>Images</th>
                <th class="text-center"><i class="fas fa-cog me-2"></i>Actions</th>
            </tr>
        </thead>
        <tbody>
            {% for record in records %}
            <tr>
                <td>
                    <div>
                        <strong>{{ record.patient.user.get_full_name|default:record.patient.user.username }}</strong>
                        <br>
                        <small class="text-muted">
                            <i class="fas fa-envelope"></i> {{ record.patient.user.email }}
                        </small>
                    </div>
                </td>
                <td>
                    <strong>{{ record.visit_date|date:"M d, Y" }}</strong>
                    <br>
                    <small class="text-muted">{{ record.visit_date|time:"g:i A" }}</small>
                </td>
                <td>
                    <div style="max-width: 200px;">
                        {{ record.chief_complaint|truncatewords:10 }}
                    </div>
                </td>
                <td>
                    <div style="max-width: 200px;">
                        {% if record.diagnosis %}
                            {{ record.diagnosis|truncatewords:10 }}
                        {% else %}
                            <span class="text-muted">Not recorded</span>
                        {% endif %}
                    </div>
                </td>
                <td>
                    <!-- Debug: Prescription count = {{ record.prescriptions.count }} -->
                    {% if record.prescriptions.count > 0 %}
                        <button 
                            class="btn btn-sm btn-success"
                            hx-get="{% url 'bookings_v2:htmx_prescriptions' record.id %}"
                            hx-target="#prescriptionsModalBody"
                            hx-swap="innerHTML"
                            data-bs-toggle="modal"
                            data-bs-target="#prescriptionsModal"
                            title="View Prescriptions"
                        >
                            <i class="fas fa-pills"></i>
                            <span class="badge bg-white text-success ms-1">{{ record.prescriptions.count }}</span>
                        </button>
                    {% else %}
                        <span class="badge bg-secondary">
                            <i class="fas fa-minus"></i> None
                        </span>
                    {% endif %}
                </td>
                <td class="text-center">
                    <!-- Debug: Images count = {{ record.images.count }} -->
                    {% if record.images.count > 0 %}
                        <button 
                            class="btn btn-sm btn-info"
                            hx-get="{% url 'bookings_v2:htmx_medical_images' record.id %}"
                            hx-target="#medicalImagesModalBody"
                            hx-swap="innerHTML"
                            data-bs-toggle="modal"
                            data-bs-target="#medicalImagesModal"
                            title="View Medical Images"
                        >
                            <i class="fas fa-images"></i>
                            <span class="badge bg-white text-info ms-1">{{ record.images.count }}</span>
                        </button>
                    {% else %}
                        <span class="text-muted">
                            <i class="fas fa-image-slash"></i> None
                        </span>
                    {% endif %}
                </td>
                <td class="text-center">
                    <button 
                        class="btn btn-sm btn-primary"
                        hx-get="{% url 'bookings_v2:htmx_medical_record_edit_form' record.id %}"
                        hx-target="#medicalRecordsModalBody"
                        hx-swap="innerHTML"
                        title="Edit Record"
                    >
                        <i class="fas fa-edit"></i>
                    </button>
                </td>
            </tr>
            {% endfor %}
        </tbody>
    </table>
</div>
{% else %}
<div class="alert alert-info text-center my-4">
    <i class="fas fa-info-circle fa-2x mb-3"></i>
    <h5>No Medical Records Found</h5>
    <p class="mb-0">There are no medical records matching your criteria.</p>
</div>
{% endif %}
