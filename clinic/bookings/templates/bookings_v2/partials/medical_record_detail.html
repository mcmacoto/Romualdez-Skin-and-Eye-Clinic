<!-- HTMX Partial: Medical Record Detail View -->
<div class="medical-record-detail-container">
    <!-- Record Header -->
    <div class="record-header mb-4">
        <div class="row align-items-center">
            <div class="col-md-8">
                <h4 class="mb-2">
                    <i class="fas fa-file-medical text-primary me-2"></i>
                    Medical Record Details
                </h4>
                <p class="text-muted mb-0">
                    <strong>Patient:</strong> {{ record.patient.user.get_full_name|default:record.patient.user.username }}
                    <span class="mx-2">|</span>
                    <strong>Visit Date:</strong> {{ record.visit_date|date:"F d, Y - g:i A" }}
                </p>
            </div>
            <div class="col-md-4 text-end">
                <button 
                    class="btn btn-secondary btn-sm"
                    hx-get="{% url 'bookings_v2:htmx_medical_records_list' %}"
                    hx-target="#medicalRecordsModalBody"
                    hx-swap="innerHTML"
                >
                    <i class="fas fa-arrow-left"></i> Back to List
                </button>
            </div>
        </div>
    </div>

    <!-- Patient Information -->
    <div class="card mb-4">
        <div class="card-header bg-primary text-white">
            <i class="fas fa-user me-2"></i>Patient Information
        </div>
        <div class="card-body">
            <div class="row">
                <div class="col-md-6 mb-3">
                    <strong class="text-muted d-block">Full Name:</strong>
                    {{ record.patient.user.get_full_name|default:record.patient.user.username }}
                </div>
                <div class="col-md-6 mb-3">
                    <strong class="text-muted d-block">Email:</strong>
                    {{ record.patient.user.email }}
                </div>
                <div class="col-md-6 mb-3">
                    <strong class="text-muted d-block">Phone:</strong>
                    {{ record.patient.phone|default:"N/A" }}
                </div>
                <div class="col-md-6 mb-3">
                    <strong class="text-muted d-block">Date of Birth:</strong>
                    {% if record.patient.date_of_birth %}
                        {{ record.patient.date_of_birth|date:"F d, Y" }}
                    {% else %}
                        <span class="text-muted">Not provided</span>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>

    <!-- Medical Details -->
    <div class="card mb-4">
        <div class="card-header bg-danger text-white">
            <i class="fas fa-stethoscope me-2"></i>Medical Details
        </div>
        <div class="card-body">
            <div class="row">
                <div class="col-md-12 mb-3">
                    <strong class="text-muted d-block mb-2">Chief Complaint:</strong>
                    <div class="p-3 bg-light rounded">
                        {{ record.chief_complaint }}
                    </div>
                </div>
                <div class="col-md-12 mb-3">
                    <strong class="text-muted d-block mb-2">Diagnosis:</strong>
                    <div class="p-3 bg-light rounded">
                        {% if record.diagnosis %}
                            {{ record.diagnosis }}
                        {% else %}
                            <span class="text-muted">Not recorded</span>
                        {% endif %}
                    </div>
                </div>
                {% if record.treatment %}
                <div class="col-md-12 mb-3">
                    <strong class="text-muted d-block mb-2">Treatment:</strong>
                    <div class="p-3 bg-light rounded">
                        {{ record.treatment }}
                    </div>
                </div>
                {% endif %}
                {% if record.notes %}
                <div class="col-md-12 mb-3">
                    <strong class="text-muted d-block mb-2">Additional Notes:</strong>
                    <div class="p-3 bg-light rounded">
                        {{ record.notes }}
                    </div>
                </div>
                {% endif %}
            </div>
        </div>
    </div>

    <!-- Vital Signs (if available) -->
    {% if record.blood_pressure or record.temperature or record.pulse_rate or record.respiratory_rate or record.weight or record.height %}
    <div class="card mb-4">
        <div class="card-header bg-info text-white">
            <i class="fas fa-heartbeat me-2"></i>Vital Signs
        </div>
        <div class="card-body">
            <div class="row">
                {% if record.blood_pressure %}
                <div class="col-md-4 mb-3">
                    <div class="vital-sign-box text-center p-3 bg-light rounded">
                        <i class="fas fa-tint text-danger fa-2x mb-2"></i>
                        <h5 class="mb-0">{{ record.blood_pressure }}</h5>
                        <small class="text-muted">Blood Pressure</small>
                    </div>
                </div>
                {% endif %}
                {% if record.temperature %}
                <div class="col-md-4 mb-3">
                    <div class="vital-sign-box text-center p-3 bg-light rounded">
                        <i class="fas fa-thermometer-half text-warning fa-2x mb-2"></i>
                        <h5 class="mb-0">{{ record.temperature }}Â°C</h5>
                        <small class="text-muted">Temperature</small>
                    </div>
                </div>
                {% endif %}
                {% if record.pulse_rate %}
                <div class="col-md-4 mb-3">
                    <div class="vital-sign-box text-center p-3 bg-light rounded">
                        <i class="fas fa-heart text-danger fa-2x mb-2"></i>
                        <h5 class="mb-0">{{ record.pulse_rate }} bpm</h5>
                        <small class="text-muted">Pulse Rate</small>
                    </div>
                </div>
                {% endif %}
                {% if record.respiratory_rate %}
                <div class="col-md-4 mb-3">
                    <div class="vital-sign-box text-center p-3 bg-light rounded">
                        <i class="fas fa-lungs text-info fa-2x mb-2"></i>
                        <h5 class="mb-0">{{ record.respiratory_rate }} /min</h5>
                        <small class="text-muted">Respiratory Rate</small>
                    </div>
                </div>
                {% endif %}
                {% if record.weight %}
                <div class="col-md-4 mb-3">
                    <div class="vital-sign-box text-center p-3 bg-light rounded">
                        <i class="fas fa-weight text-success fa-2x mb-2"></i>
                        <h5 class="mb-0">{{ record.weight }} kg</h5>
                        <small class="text-muted">Weight</small>
                    </div>
                </div>
                {% endif %}
                {% if record.height %}
                <div class="col-md-4 mb-3">
                    <div class="vital-sign-box text-center p-3 bg-light rounded">
                        <i class="fas fa-ruler-vertical text-primary fa-2x mb-2"></i>
                        <h5 class="mb-0">{{ record.height }} cm</h5>
                        <small class="text-muted">Height</small>
                    </div>
                </div>
                {% endif %}
            </div>
        </div>
    </div>
    {% endif %}

    <!-- Prescriptions -->
    <div class="card mb-4">
        <div class="card-header bg-success text-white d-flex justify-content-between align-items-center">
            <span><i class="fas fa-pills me-2"></i>Prescriptions</span>
            <span class="badge bg-white text-success">{{ record.prescriptions.count }}</span>
        </div>
        <div class="card-body">
            {% if record.prescriptions.count > 0 %}
            <div class="table-responsive">
                <table class="table table-sm table-hover">
                    <thead>
                        <tr>
                            <th>Medication</th>
                            <th>Dosage</th>
                            <th>Quantity</th>
                            <th>Duration</th>
                            <th>Instructions</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for prescription in record.prescriptions.all %}
                        <tr>
                            <td>
                                <strong>
                                    {% if prescription.custom_medicine_name %}
                                        {{ prescription.custom_medicine_name }}
                                        <span class="badge bg-warning text-dark ms-1">External</span>
                                    {% else %}
                                        {{ prescription.medicine.name }}
                                    {% endif %}
                                </strong>
                            </td>
                            <td>{{ prescription.dosage }}</td>
                            <td>{{ prescription.quantity }}</td>
                            <td>{{ prescription.duration|default:"As needed" }}</td>
                            <td>
                                {% if prescription.instructions %}
                                    {{ prescription.instructions|truncatewords:10 }}
                                {% else %}
                                    <span class="text-muted">N/A</span>
                                {% endif %}
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
            <div class="mt-3">
                <button 
                    class="btn btn-success btn-sm"
                    hx-get="{% url 'bookings_v2:htmx_prescriptions' record.id %}"
                    hx-target="#prescriptionsModalBody"
                    hx-swap="innerHTML"
                    data-bs-toggle="modal"
                    data-bs-target="#prescriptionsModal"
                >
                    <i class="fas fa-eye"></i> View Full Prescriptions
                </button>
            </div>
            {% else %}
            <p class="text-muted mb-0">No prescriptions recorded for this visit.</p>
            {% endif %}
        </div>
    </div>

    <!-- Medical Images -->
    <div class="card mb-4">
        <div class="card-header bg-warning text-dark d-flex justify-content-between align-items-center">
            <span><i class="fas fa-images me-2"></i>Medical Images</span>
            <span class="badge bg-dark">{{ record.images.count }}</span>
        </div>
        <div class="card-body">
            {% if record.images.count > 0 %}
            <div class="row">
                {% for image in record.images.all %}
                <div class="col-md-4 mb-3">
                    <div class="card">
                        <img src="{{ image.image.url }}" class="card-img-top" alt="{{ image.title }}" style="height: 200px; object-fit: cover;">
                        <div class="card-body p-2">
                            <h6 class="card-title mb-1">{{ image.title }}</h6>
                            <small class="text-muted">{{ image.image_type|title }}</small>
                        </div>
                    </div>
                </div>
                {% endfor %}
            </div>
            <div class="mt-3">
                <button 
                    class="btn btn-info btn-sm"
                    hx-get="{% url 'bookings_v2:htmx_medical_images' record.id %}"
                    hx-target="#medicalImagesModalBody"
                    hx-swap="innerHTML"
                    data-bs-toggle="modal"
                    data-bs-target="#medicalImagesModal"
                >
                    <i class="fas fa-eye"></i> View All Images
                </button>
            </div>
            {% else %}
            <p class="text-muted mb-0">No medical images attached to this record.</p>
            {% endif %}
        </div>
    </div>

    <!-- Record Metadata -->
    <div class="card">
        <div class="card-header bg-secondary text-white">
            <i class="fas fa-info-circle me-2"></i>Record Information
        </div>
        <div class="card-body">
            <div class="row">
                <div class="col-md-6 mb-2">
                    <strong class="text-muted">Created By:</strong>
                    {{ record.created_by.get_full_name|default:record.created_by.username }}
                </div>
                <div class="col-md-6 mb-2">
                    <strong class="text-muted">Created On:</strong>
                    {{ record.created_at|date:"F d, Y - g:i A" }}
                </div>
                {% if record.updated_at != record.created_at %}
                <div class="col-md-6 mb-2">
                    <strong class="text-muted">Last Updated By:</strong>
                    {{ record.updated_by.get_full_name|default:record.updated_by.username }}
                </div>
                <div class="col-md-6 mb-2">
                    <strong class="text-muted">Last Updated:</strong>
                    {{ record.updated_at|date:"F d, Y - g:i A" }}
                </div>
                {% endif %}
            </div>
        </div>
    </div>

    <!-- Action Buttons -->
    <div class="mt-4 text-end">
        <button 
            class="btn btn-warning"
            hx-get="{% url 'bookings_v2:htmx_medical_record_edit_form' record.id %}"
            hx-target="#medicalRecordsModalBody"
            hx-swap="innerHTML"
        >
            <i class="fas fa-edit"></i> Edit Record
        </button>
        <button 
            class="btn btn-secondary"
            hx-get="{% url 'bookings_v2:htmx_medical_records_list' %}"
            hx-target="#medicalRecordsModalBody"
            hx-swap="innerHTML"
        >
            <i class="fas fa-arrow-left"></i> Back to List
        </button>
    </div>
</div>

<style>
    .record-header {
        background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
        padding: 1.5rem;
        border-radius: 10px;
    }
    
    .vital-sign-box {
        transition: transform 0.3s ease, box-shadow 0.3s ease;
        border: 1px solid #dee2e6;
    }
    
    .vital-sign-box:hover {
        transform: translateY(-5px);
        box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
    }
</style>
