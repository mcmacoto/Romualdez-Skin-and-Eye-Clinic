{% load static %}
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="{% block meta_description %}Professional skin care services at Romualdez Clinic. Expert dermatologists providing comprehensive dermatological healthcare.{% endblock %}">
    <meta name="keywords" content="{% block meta_keywords %}dermatology, skin clinic, cosmetic treatments, acne treatment, skin cancer screening{% endblock %}">
    
    <title>{% block title %}Romualdez Skin Clinic{% endblock %}</title>
    
    <!-- CSS Files -->
    <link rel="stylesheet" href="{% static 'css/main.css' %}">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <!-- Favicon -->
    <link rel="icon" type="image/x-icon" href="{% static 'images/favicon.ico' %}">
    
    {% block extra_head %}{% endblock %}
</head>
<body>
    <!-- Skip to content for accessibility -->
    <a href="#main-content" class="skip-link">Skip to main content</a>
    
    <!-- Navigation -->
    <nav class="navbar" role="navigation" aria-label="Main navigation">
        <div class="navbar-container">
            <a href="{% url 'home' %}" class="logo" aria-label="Romualdez Skin Clinic Home">
                <img src="{% static 'images/logo.jpeg' %}" alt="Clinic Logo" onerror="this.style.display='none';">
                <span class="title">Romualdez Skin Clinic</span>
            </a>
            
            <button class="mobile-menu-toggle" aria-label="Toggle mobile menu" onclick="toggleMobileMenu()">
                <i class="fas fa-bars"></i>
            </button>
            
            <div class="nav-links" id="navLinks">
                <ul role="menubar">
                    <li role="none">
                        <a href="{% url 'home' %}" role="menuitem" class="nav-link {% if request.resolver_match.url_name == 'home' %}active{% endif %}">
                            <i class="fas fa-home" aria-hidden="true"></i>
                            <span>Home</span>
                        </a>
                    </li>
                    <li role="none">
                        <a href="{% url 'booking' %}" role="menuitem" class="nav-link {% if request.resolver_match.url_name == 'booking' %}active{% endif %}">
                            <i class="fas fa-calendar-plus" aria-hidden="true"></i>
                            <span>Booking</span>
                        </a>
                    </li>
                    <li role="none">
                        <a href="{% url 'about' %}" role="menuitem" class="nav-link {% if request.resolver_match.url_name == 'about' %}active{% endif %}">
                            <i class="fas fa-info-circle" aria-hidden="true"></i>
                            <span>About Us</span>
                        </a>
                    </li>
                    <li role="none">
                        <a href="{% url 'services' %}" role="menuitem" class="nav-link {% if request.resolver_match.url_name == 'services' %}active{% endif %}">
                            <i class="fas fa-stethoscope" aria-hidden="true"></i>
                            <span>Services</span>
                        </a>
                    </li>
                    <li role="none">
                        <a href="{% url 'contact' %}" role="menuitem" class="nav-link {% if request.resolver_match.url_name == 'contact' %}active{% endif %}">
                            <i class="fas fa-phone" aria-hidden="true"></i>
                            <span>Contact</span>
                        </a>
                    </li>
                </ul>
            </div>
            
            <div class="user-section">
                <span class="user-message" role="status" aria-live="polite">
                    Hello, {% if user.is_authenticated %}{{ user.username }}{% else %}Guest{% endif %}!
                </span>
                {% if user.is_authenticated %}
                    {% if not user.is_staff %}
                    <button class="profile-btn" onclick="showProfileModal()" aria-label="View my profile">
                        <i class="fas fa-user-circle" aria-hidden="true"></i>
                        <span>My Profile</span>
                    </button>
                    {% endif %}
                    <form method="post" action="{% url 'logout' %}" style="display:inline;">
                        {% csrf_token %}
                        <button class="login-btn" type="submit" aria-label="Log out patient account">
                            <i class="fas fa-sign-out-alt" aria-hidden="true"></i>
                            <span>Patient Logout</span>
                        </button>
                    </form>
                {% else %}
                    <button class="login-btn" onclick="showLoginModal()" aria-label="Open patient login">
                        <i class="fas fa-sign-in-alt" aria-hidden="true"></i>
                        <span>Patient Login</span>
                    </button>
                {% endif %}
                <a href="/admin/login/" class="logout-btn" aria-label="Staff login portal">
                    <i class="fas fa-user-md" aria-hidden="true"></i>
                    <span>Staff Login</span>
                </a>
            </div>
        </div>
    </nav>

    <!-- Messages -->
    {% if messages %}
        <div class="messages-container" role="alert" aria-live="assertive">
            {% for message in messages %}
                <div class="alert alert-{{ message.tags|default:'info' }} fade-in">
                    <i class="fas fa-{% if message.tags == 'success' %}check-circle{% elif message.tags == 'error' %}exclamation-circle{% elif message.tags == 'warning' %}exclamation-triangle{% else %}info-circle{% endif %}" aria-hidden="true"></i>
                    {{ message }}
                </div>
            {% endfor %}
        </div>
    {% endif %}

    <!-- Main Content -->
    <main id="main-content" class="main-content" role="main">
        {% block content %}{% endblock %}
    </main>

    <!-- Footer -->
    <footer class="footer" role="contentinfo">
        <div class="footer-content">
            <p>&copy; 2025 Romualdez Skin Clinic | All rights reserved</p>
            <p>
                <a href="tel:+63-2-8123-4567" style="color: white; text-decoration: none;">
                    <i class="fas fa-phone" aria-hidden="true"></i> (02) 8123-4567
                </a>
                |
                <a href="mailto:info@romualdezclinic.com" style="color: white; text-decoration: none;">
                    <i class="fas fa-envelope" aria-hidden="true"></i> info@romualdezclinic.com
                </a>
            </p>
        </div>
    </footer>

    <!-- Login Modal -->
    <div id="loginModal" class="modal-overlay" role="dialog" aria-labelledby="modal-title" aria-hidden="true">
        <div class="modal-content">
            <div class="modal-header">
                <h2 id="modal-title" class="modal-title">Patient Login</h2>
            </div>
            <form method="post" action="{% url 'login' %}" id="loginForm">
                {% csrf_token %}
                <input type="hidden" name="next" value="{{ request.get_full_path }}" />
                
                <div class="form-group">
                    <label for="username" class="form-label">Username</label>
                    <input type="text" name="username" id="username" class="form-control" required aria-describedby="username-help">
                    <div id="username-help" class="form-text">Enter your registered username</div>
                </div>

                <div class="form-group">
                    <label for="password" class="form-label">Password</label>
                    <input type="password" name="password" id="password" class="form-control" required aria-describedby="password-help">
                    <div id="password-help" class="form-text">Enter your password</div>
                </div>

                <div class="modal-actions">
                    <button type="button" class="btn btn-secondary" onclick="hideLoginModal()">
                        <i class="fas fa-times" aria-hidden="true"></i>
                        Cancel
                    </button>
                    <button type="submit" class="btn btn-primary">
                        <i class="fas fa-sign-in-alt" aria-hidden="true"></i>
                        Login
                    </button>
                </div>
            </form>
        </div>
    </div>

    <!-- Loading Overlay -->
    <div id="loadingOverlay" class="modal-overlay" style="background: rgba(255,255,255,0.8);">
        <div style="text-align: center; color: var(--primary-color);">
            <i class="fas fa-spinner fa-spin fa-3x" aria-hidden="true"></i>
            <p style="margin-top: 1rem; font-weight: 500;">Loading...</p>
        </div>
    </div>

    <!-- Patient Profile Modal -->
    <div id="profileModal" class="modal-overlay" role="dialog" aria-labelledby="profile-modal-title" aria-hidden="true">
        <div class="modal-content profile-modal-content">
            <button class="modal-close-btn" onclick="hideProfileModal()" aria-label="Close profile modal">
                <i class="fas fa-times"></i>
            </button>
            <div class="modal-header">
                <h2 id="profile-modal-title" class="modal-title">
                    <i class="fas fa-user-circle"></i> My Profile
                </h2>
            </div>
            <div id="profileContent">
                <div style="text-align: center; padding: 2rem;">
                    <i class="fas fa-spinner fa-spin fa-2x" style="color: var(--primary-color);"></i>
                    <p style="margin-top: 1rem;">Loading profile...</p>
                </div>
            </div>
        </div>
    </div>

    <!-- JavaScript -->
    <script>
        // Mobile menu toggle
        function toggleMobileMenu() {
            const navLinks = document.getElementById('navLinks');
            const toggleBtn = document.querySelector('.mobile-menu-toggle i');
            
            navLinks.classList.toggle('active');
            toggleBtn.classList.toggle('fa-bars');
            toggleBtn.classList.toggle('fa-times');
        }

        // Modal functions
        function showLoginModal() {
            const modal = document.getElementById('loginModal');
            modal.classList.add('active');
            modal.setAttribute('aria-hidden', 'false');
            document.getElementById('username').focus();
            document.body.style.overflow = 'hidden';
        }

        function hideLoginModal() {
            const modal = document.getElementById('loginModal');
            modal.classList.remove('active');
            modal.setAttribute('aria-hidden', 'true');
            document.body.style.overflow = '';
        }

        // Loading functions
        function showLoading() {
            document.getElementById('loadingOverlay').classList.add('active');
        }

        function hideLoading() {
            document.getElementById('loadingOverlay').classList.remove('active');
        }

        // Profile Modal functions
        function showProfileModal() {
            const modal = document.getElementById('profileModal');
            modal.classList.add('active');
            modal.setAttribute('aria-hidden', 'false');
            document.body.style.overflow = 'hidden';
            loadPatientProfile();
        }

        function hideProfileModal() {
            const modal = document.getElementById('profileModal');
            modal.classList.remove('active');
            modal.setAttribute('aria-hidden', 'true');
            document.body.style.overflow = '';
        }

        // Load patient profile data
        async function loadPatientProfile() {
            const profileContent = document.getElementById('profileContent');
            
            try {
                const response = await fetch('/api/patient-profile/');
                
                if (!response.ok) {
                    throw new Error('Failed to load profile');
                }
                
                const data = await response.json();
                
                if (data.error) {
                    profileContent.innerHTML = `
                        <div class="no-records-message">
                            <i class="fas fa-exclamation-circle fa-3x" style="color: var(--warning);"></i>
                            <p style="margin-top: 1rem;">${data.error}</p>
                        </div>
                    `;
                    return;
                }
                
                // Build profile HTML
                let html = `
                    <!-- Personal Information -->
                    <div class="profile-section">
                        <h3><i class="fas fa-user"></i> Personal Information</h3>
                        <div class="profile-info-grid">
                            <div class="profile-info-item">
                                <div class="profile-info-label">Full Name</div>
                                <div class="profile-info-value">${data.full_name}</div>
                            </div>
                            <div class="profile-info-item">
                                <div class="profile-info-label">Email</div>
                                <div class="profile-info-value">${data.email}</div>
                            </div>
                            <div class="profile-info-item">
                                <div class="profile-info-label">Date of Birth</div>
                                <div class="profile-info-value">${data.date_of_birth}</div>
                            </div>
                            <div class="profile-info-item">
                                <div class="profile-info-label">Gender</div>
                                <div class="profile-info-value">${data.gender}</div>
                            </div>
                            <div class="profile-info-item">
                                <div class="profile-info-label">Phone</div>
                                <div class="profile-info-value">${data.phone || 'Not provided'}</div>
                            </div>
                            <div class="profile-info-item">
                                <div class="profile-info-label">Blood Type</div>
                                <div class="profile-info-value">${data.blood_type}</div>
                            </div>
                        </div>
                        ${data.address ? `
                        <div class="profile-text-area">
                            <div class="profile-info-label">Address</div>
                            <div class="profile-info-value">${data.address}</div>
                        </div>
                        ` : ''}
                    </div>
                    
                    <!-- Emergency Contact -->
                    ${data.emergency_contact_name ? `
                    <div class="profile-section">
                        <h3><i class="fas fa-phone-alt"></i> Emergency Contact</h3>
                        <div class="profile-info-grid">
                            <div class="profile-info-item">
                                <div class="profile-info-label">Contact Name</div>
                                <div class="profile-info-value">${data.emergency_contact_name}</div>
                            </div>
                            <div class="profile-info-item">
                                <div class="profile-info-label">Contact Phone</div>
                                <div class="profile-info-value">${data.emergency_contact_phone}</div>
                            </div>
                        </div>
                    </div>
                    ` : ''}
                    
                    <!-- Medical Information -->
                    <div class="profile-section">
                        <h3><i class="fas fa-heartbeat"></i> Medical Information</h3>
                        ${data.allergies ? `
                        <div class="profile-text-area">
                            <div class="profile-info-label">Allergies</div>
                            <div class="profile-info-value">${data.allergies}</div>
                        </div>
                        ` : ''}
                        ${data.current_medications ? `
                        <div class="profile-text-area">
                            <div class="profile-info-label">Current Medications</div>
                            <div class="profile-info-value">${data.current_medications}</div>
                        </div>
                        ` : ''}
                        ${data.medical_history ? `
                        <div class="profile-text-area">
                            <div class="profile-info-label">Medical History</div>
                            <div class="profile-info-value">${data.medical_history}</div>
                        </div>
                        ` : ''}
                        ${!data.allergies && !data.current_medications && !data.medical_history ? `
                        <p style="color: var(--text-muted); font-style: italic;">No medical information recorded.</p>
                        ` : ''}
                    </div>
                    
                    <!-- Billing Summary -->
                    ${data.billing_summary ? `
                    <div class="profile-section">
                        <h3><i class="fas fa-wallet"></i> Billing & Payments Summary</h3>
                        <div class="billing-overview">
                            <div class="billing-stat-grid">
                                <div class="billing-stat-card balance-card">
                                    <div class="billing-stat-icon">
                                        <i class="fas fa-exclamation-circle"></i>
                                    </div>
                                    <div class="billing-stat-content">
                                        <div class="billing-stat-label">Remaining Balance</div>
                                        <div class="billing-stat-value balance-amount">₱${data.billing_summary.remaining_balance.toLocaleString('en-PH', {minimumFractionDigits: 2, maximumFractionDigits: 2})}</div>
                                    </div>
                                </div>
                                <div class="billing-stat-card total-card">
                                    <div class="billing-stat-icon">
                                        <i class="fas fa-file-invoice-dollar"></i>
                                    </div>
                                    <div class="billing-stat-content">
                                        <div class="billing-stat-label">Total Billed</div>
                                        <div class="billing-stat-value">₱${data.billing_summary.total_billed.toLocaleString('en-PH', {minimumFractionDigits: 2, maximumFractionDigits: 2})}</div>
                                    </div>
                                </div>
                                <div class="billing-stat-card paid-card">
                                    <div class="billing-stat-icon">
                                        <i class="fas fa-check-circle"></i>
                                    </div>
                                    <div class="billing-stat-content">
                                        <div class="billing-stat-label">Total Paid</div>
                                        <div class="billing-stat-value">₱${data.billing_summary.total_paid.toLocaleString('en-PH', {minimumFractionDigits: 2, maximumFractionDigits: 2})}</div>
                                    </div>
                                </div>
                                <div class="billing-stat-card summary-card">
                                    <div class="billing-stat-icon">
                                        <i class="fas fa-chart-pie"></i>
                                    </div>
                                    <div class="billing-stat-content">
                                        <div class="billing-stat-label">Bills Status</div>
                                        <div class="billing-stat-value">${data.billing_summary.paid_billings} Paid / ${data.billing_summary.unpaid_billings} Unpaid</div>
                                    </div>
                                </div>
                            </div>
                            
                            ${data.billing_summary.recent_billings && data.billing_summary.recent_billings.length > 0 ? `
                            <div class="recent-transactions">
                                <h4 style="margin: 1.5rem 0 1rem 0; color: var(--text-dark);">
                                    <i class="fas fa-history"></i> Recent Billings
                                </h4>
                                <div class="transaction-list">
                                    ${data.billing_summary.recent_billings.map(bill => `
                                        <div class="transaction-item ${bill.is_paid ? 'paid' : 'unpaid'}">
                                            <div class="transaction-header">
                                                <div class="transaction-service">
                                                    <i class="fas fa-stethoscope"></i>
                                                    <strong>${bill.service}</strong>
                                                </div>
                                                <div class="transaction-badge ${bill.is_paid ? 'badge-paid' : 'badge-unpaid'}">
                                                    ${bill.status}
                                                </div>
                                            </div>
                                            <div class="transaction-details">
                                                <div class="transaction-detail-row">
                                                    <span class="detail-label">Date:</span>
                                                    <span class="detail-value">${bill.booking_date}</span>
                                                </div>
                                                <div class="transaction-detail-row">
                                                    <span class="detail-label">Total Amount:</span>
                                                    <span class="detail-value">₱${bill.total_amount.toLocaleString('en-PH', {minimumFractionDigits: 2})}</span>
                                                </div>
                                                <div class="transaction-detail-row">
                                                    <span class="detail-label">Amount Paid:</span>
                                                    <span class="detail-value paid-amount">₱${bill.amount_paid.toLocaleString('en-PH', {minimumFractionDigits: 2})}</span>
                                                </div>
                                                ${!bill.is_paid ? `
                                                <div class="transaction-detail-row">
                                                    <span class="detail-label">Balance:</span>
                                                    <span class="detail-value balance-highlight">₱${bill.balance.toLocaleString('en-PH', {minimumFractionDigits: 2})}</span>
                                                </div>
                                                ` : ''}
                                            </div>
                                        </div>
                                    `).join('')}
                                </div>
                            </div>
                            ` : ''}
                            
                            ${data.billing_summary.recent_payments && data.billing_summary.recent_payments.length > 0 ? `
                            <div class="recent-transactions">
                                <h4 style="margin: 1.5rem 0 1rem 0; color: var(--text-dark);">
                                    <i class="fas fa-receipt"></i> Recent Payments
                                </h4>
                                <div class="payment-list">
                                    ${data.billing_summary.recent_payments.map(payment => `
                                        <div class="payment-item">
                                            <div class="payment-icon">
                                                <i class="fas fa-money-check-alt"></i>
                                            </div>
                                            <div class="payment-content">
                                                <div class="payment-amount">₱${payment.amount.toLocaleString('en-PH', {minimumFractionDigits: 2})}</div>
                                                <div class="payment-method">${payment.payment_method}</div>
                                                <div class="payment-date">${payment.payment_date}</div>
                                                ${payment.reference_number ? `
                                                <div class="payment-ref">Ref: ${payment.reference_number}</div>
                                                ` : ''}
                                            </div>
                                        </div>
                                    `).join('')}
                                </div>
                            </div>
                            ` : ''}
                        </div>
                    </div>
                    ` : ''}
                    
                    <!-- Medical Records -->
                    <div class="profile-section">
                        <h3><i class="fas fa-file-medical"></i> Medical Records (${data.medical_records.length})</h3>
                `;
                
                if (data.medical_records.length > 0) {
                    data.medical_records.forEach(record => {
                        html += `
                            <div class="medical-record-card">
                                <div class="medical-record-header">
                                    <div class="medical-record-date">
                                        <i class="fas fa-calendar-day"></i> ${record.visit_date}
                                    </div>
                                </div>
                                <div class="medical-record-body">
                                    <div class="medical-record-row">
                                        <strong>Chief Complaint:</strong>
                                        <span>${record.chief_complaint}</span>
                                    </div>
                                    ${record.symptoms ? `
                                    <div class="medical-record-row">
                                        <strong>Symptoms:</strong>
                                        <span>${record.symptoms}</span>
                                    </div>
                                    ` : ''}
                                    ${record.diagnosis ? `
                                    <div class="medical-record-row">
                                        <strong>Diagnosis:</strong>
                                        <span>${record.diagnosis}</span>
                                    </div>
                                    ` : ''}
                                    ${record.treatment_plan ? `
                                    <div class="medical-record-row">
                                        <strong>Treatment Plan:</strong>
                                        <span>${record.treatment_plan}</span>
                                    </div>
                                    ` : ''}
                                    ${record.has_vitals ? `
                                    <div class="vital-signs-grid">
                                        ${record.temperature ? `
                                        <div class="vital-sign">
                                            <div class="vital-sign-label">Temperature</div>
                                            <div class="vital-sign-value">${record.temperature}°C</div>
                                        </div>
                                        ` : ''}
                                        ${record.blood_pressure ? `
                                        <div class="vital-sign">
                                            <div class="vital-sign-label">Blood Pressure</div>
                                            <div class="vital-sign-value">${record.blood_pressure}</div>
                                        </div>
                                        ` : ''}
                                        ${record.heart_rate ? `
                                        <div class="vital-sign">
                                            <div class="vital-sign-label">Heart Rate</div>
                                            <div class="vital-sign-value">${record.heart_rate} BPM</div>
                                        </div>
                                        ` : ''}
                                        ${record.weight ? `
                                        <div class="vital-sign">
                                            <div class="vital-sign-label">Weight</div>
                                            <div class="vital-sign-value">${record.weight} kg</div>
                                        </div>
                                        ` : ''}
                                        ${record.height ? `
                                        <div class="vital-sign">
                                            <div class="vital-sign-label">Height</div>
                                            <div class="vital-sign-value">${record.height} cm</div>
                                        </div>
                                        ` : ''}
                                    </div>
                                    ` : ''}
                                    ${record.images && record.images.length > 0 ? `
                                    <div style="margin-top: 1rem;">
                                        <strong style="color: var(--text-light); font-size: 0.9rem;">
                                            <i class="fas fa-images"></i> Medical Images (${record.images.length})
                                        </strong>
                                        <div class="medical-images-grid">
                                            ${record.images.map(img => `
                                                <div class="medical-image-card" onclick="window.open('${img.url}', '_blank')">
                                                    <img src="${img.url}" alt="${img.title}" loading="lazy">
                                                    <div class="medical-image-title">${img.title}</div>
                                                </div>
                                            `).join('')}
                                        </div>
                                    </div>
                                    ` : ''}
                                </div>
                            </div>
                        `;
                    });
                } else {
                    html += `
                        <div class="no-records-message">
                            <i class="fas fa-clipboard fa-3x" style="color: var(--text-muted);"></i>
                            <p style="margin-top: 1rem;">No medical records found.</p>
                        </div>
                    `;
                }
                
                html += `</div>`;
                
                profileContent.innerHTML = html;
                
            } catch (error) {
                console.error('Error loading profile:', error);
                profileContent.innerHTML = `
                    <div class="no-records-message">
                        <i class="fas fa-exclamation-triangle fa-3x" style="color: var(--error);"></i>
                        <p style="margin-top: 1rem;">Failed to load profile. Please try again.</p>
                    </div>
                `;
            }
        }

        // Form submission with loading
        document.addEventListener('DOMContentLoaded', function() {
            // Auto-hide messages after 5 seconds
            const alerts = document.querySelectorAll('.alert');
            alerts.forEach(alert => {
                setTimeout(() => {
                    alert.style.opacity = '0';
                    alert.style.transform = 'translateY(-10px)';
                    setTimeout(() => alert.remove(), 300);
                }, 5000);
            });

            // Add loading to form submissions (exclude forms with custom handlers)
            const forms = document.querySelectorAll('form:not(#loginForm):not(#bookingForm)');
            forms.forEach(form => {
                form.addEventListener('submit', function() {
                    showLoading();
                });
            });

            // Login form handling
            const loginForm = document.getElementById('loginForm');
            if (loginForm) {
                loginForm.addEventListener('submit', function(e) {
                    showLoading();
                    hideLoginModal();
                });
            }
        });

        // Keyboard navigation
        document.addEventListener('keydown', function(e) {
            if (e.key === 'Escape') {
                hideLoginModal();
                hideProfileModal();
            }
        });

        // Click outside modal to close
        document.getElementById('loginModal').addEventListener('click', function(e) {
            if (e.target === this) {
                hideLoginModal();
            }
        });

        document.getElementById('profileModal').addEventListener('click', function(e) {
            if (e.target === this) {
                hideProfileModal();
            }
        });

        // Smooth scroll for anchor links
        document.querySelectorAll('a[href^="#"]').forEach(anchor => {
            anchor.addEventListener('click', function (e) {
                e.preventDefault();
                const target = document.querySelector(this.getAttribute('href'));
                if (target) {
                    target.scrollIntoView({
                        behavior: 'smooth',
                        block: 'start'
                    });
                }
            });
        });
    </script>

    {% block extra_scripts %}{% endblock %}
</body>
</html>
</html>