{% extends 'bookings/base.html' %}
{% block title %}Book Appointment - Romualdez Skin Clinic{% endblock %}

{% block meta_description %}Book your appointment online at Romualdez Skin Clinic. Easy scheduling for dermatology services.{% endblock %}

{% block extra_head %}
<style>
    .booking-container {
        max-width: 800px;
        margin: 0 auto;
    }

    .booking-header {
        text-align: center;
        margin-bottom: var(--spacing-xxl);
    }

    .booking-header h1 {
        color: var(--primary-color);
        font-size: 2.5rem;
        margin-bottom: var(--spacing-md);
    }

    .booking-header p {
        color: var(--text-light);
        font-size: 1.1rem;
        max-width: 600px;
        margin: 0 auto;
    }

    .booking-form {
        background: var(--white);
        border-radius: var(--border-radius-lg);
        padding: var(--spacing-xxl);
        box-shadow: var(--shadow-md);
    }

    .form-row {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: var(--spacing-lg);
        margin-bottom: var(--spacing-lg);
    }

    .form-row.single {
        grid-template-columns: 1fr;
    }

    .form-group {
        position: relative;
    }

    .form-label {
        display: block;
        margin-bottom: var(--spacing-sm);
        font-weight: 600;
        color: var(--primary-color);
    }

    .required::after {
        content: " *";
        color: var(--error);
    }

    .form-control {
        width: 100%;
        padding: var(--spacing-md);
        border: 2px solid var(--accent-color);
        border-radius: var(--border-radius);
        font-size: 1rem;
        transition: var(--transition-fast);
        background: var(--white);
    }

    .form-control:focus {
        outline: none;
        border-color: var(--primary-color);
        box-shadow: 0 0 0 3px rgba(61, 92, 61, 0.1);
    }

    .form-control:valid {
        border-color: var(--success);
    }

    .form-control:invalid:not(:placeholder-shown) {
        border-color: var(--error);
    }

    .form-text {
        font-size: 0.875rem;
        color: var(--text-muted);
        margin-top: var(--spacing-xs);
    }

    textarea.form-control {
        resize: vertical;
        min-height: 120px;
        font-family: inherit;
    }

    .submit-section {
        text-align: center;
        margin-top: var(--spacing-xxl);
        padding-top: var(--spacing-lg);
        border-top: 1px solid var(--accent-color);
    }

    .form-info {
        background: #e8f4f8;
        border: 1px solid #bee5eb;
        border-radius: var(--border-radius);
        padding: var(--spacing-lg);
        margin-bottom: var(--spacing-xl);
    }

    .form-info h3 {
        color: var(--primary-color);
        margin-bottom: var(--spacing-sm);
    }

    .form-info ul {
        margin: 0;
        padding-left: var(--spacing-lg);
    }

    .form-info li {
        margin-bottom: var(--spacing-xs);
        color: var(--text-dark);
    }

    .appointment-types {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        gap: var(--spacing-md);
        margin-bottom: var(--spacing-lg);
    }

    .appointment-type {
        border: 2px solid var(--accent-color);
        border-radius: var(--border-radius);
        padding: var(--spacing-lg);
        text-align: center;
        cursor: pointer;
        transition: var(--transition-fast);
    }

    .appointment-type:hover {
        border-color: var(--primary-light);
        background: rgba(61, 92, 61, 0.05);
    }

    .appointment-type input[type="radio"] {
        display: none;
    }

    .appointment-type input[type="radio"]:checked + .type-content {
        color: var(--primary-color);
    }

    .appointment-type input[type="radio"]:checked + .type-content .type-icon {
        background: var(--primary-color);
        color: var(--white);
    }

    .appointment-type:has(input[type="radio"]:checked) {
        border-color: var(--primary-color);
        background: rgba(61, 92, 61, 0.1);
    }

    .type-icon {
        width: 60px;
        height: 60px;
        border-radius: 50%;
        background: var(--accent-color);
        color: var(--primary-color);
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 1.5rem;
        margin: 0 auto var(--spacing-sm);
        transition: var(--transition-fast);
    }

    .type-title {
        font-weight: 600;
        margin-bottom: var(--spacing-xs);
    }

    .type-description {
        font-size: 0.9rem;
        color: var(--text-light);
    }

    /* Time slots */
    .time-slots {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(100px, 1fr));
        gap: var(--spacing-sm);
        margin-top: var(--spacing-md);
    }

    .time-slot {
        padding: var(--spacing-sm) var(--spacing-md);
        border: 2px solid var(--accent-color);
        border-radius: var(--border-radius);
        text-align: center;
        cursor: pointer;
        transition: var(--transition-fast);
        background: var(--white);
    }

    .time-slot:hover {
        border-color: var(--primary-light);
        background: rgba(61, 92, 61, 0.05);
    }

    .time-slot input[type="radio"] {
        display: none;
    }

    .time-slot:has(input[type="radio"]:checked) {
        border-color: var(--primary-color);
        background: var(--primary-color);
        color: var(--white);
    }

    @media (max-width: 768px) {
        .form-row {
            grid-template-columns: 1fr;
        }
        
        .booking-form {
            padding: var(--spacing-xl);
        }
        
        .booking-header h1 {
            font-size: 2rem;
        }
        
        .appointment-types {
            grid-template-columns: 1fr;
        }
        
        .time-slots {
            grid-template-columns: repeat(auto-fill, minmax(80px, 1fr));
        }
    }
</style>
{% endblock %}

{% block content %}
<div class="booking-container">
    <div class="booking-header">
        <h1><i class="fas fa-calendar-plus" aria-hidden="true"></i> Book Your Appointment</h1>
                <p>Schedule your visit with our expert dermatologists. We're here to provide you with the best care possible.</p>
    </div>

    <div class="form-info">
        <h3><i class="fas fa-info-circle" aria-hidden="true"></i> Before You Book</h3>
        <ul>
            <li>Consultations typically last 30-45 minutes</li>
            <li>Please arrive 15 minutes early for new patients</li>
            <li>Bring a valid ID and insurance information</li>
            <li>We'll confirm your appointment within 24 hours</li>
            <li>For urgent matters, please call us directly at (02) 8123-4567</li>
        </ul>
    </div>

    <form method="POST" action="{% url 'booking' %}" class="booking-form" id="bookingForm" novalidate>
        {% csrf_token %}
        
        <!-- Appointment Type Selection -->
        <div class="form-group">
            <label class="form-label required">Appointment Type</label>
            <div class="appointment-types">
                <label class="appointment-type">
                    <input type="radio" name="appointment_type" value="dermatology" required>
                    <div class="type-content">
                        <div class="type-icon">
                            <i class="fas fa-user-md" aria-hidden="true"></i>
                        </div>
                        <div class="type-title">Dermatology</div>
                        <div class="type-description">Skin care and treatment</div>
                    </div>
                </label>
                <label class="appointment-type">
                    <input type="radio" name="appointment_type" value="cosmetic" required>
                    <div class="type-content">
                        <div class="type-icon">
                            <i class="fas fa-spa" aria-hidden="true"></i>
                        </div>
                        <div class="type-title">Cosmetic</div>
                        <div class="type-description">Aesthetic treatments</div>
                    </div>
                </label>
                <label class="appointment-type">
                    <input type="radio" name="appointment_type" value="screening" required>
                    <div class="type-content">
                        <div class="type-icon">
                            <i class="fas fa-shield-alt" aria-hidden="true"></i>
                        </div>
                        <div class="type-title">Skin Cancer Screening</div>
                        <div class="type-description">Preventive examination</div>
                    </div>
                </label>
            </div>
        </div>

        <!-- Personal Information -->
        <div class="form-row">
            <div class="form-group">
                <label for="name" class="form-label required">Full Name</label>
                <input type="text" id="name" name="name" class="form-control" required 
                       placeholder="Enter your full name" 
                       pattern="^[a-zA-Z\s]{2,50}$"
                       title="Please enter a valid name (2-50 characters, letters only)">
                <div class="form-text">Enter your first and last name</div>
            </div>

            <div class="form-group">
                <label for="phone" class="form-label required">Phone Number</label>
                <input type="tel" id="phone" name="phone" class="form-control" required 
                       placeholder="+63 9XX XXX XXXX"
                       pattern="^(\+63|63|0)?[9]\d{9}$"
                       title="Please enter a valid Philippine mobile number">
                <div class="form-text">We'll use this to confirm your appointment</div>
            </div>
        </div>

        <div class="form-row single">
            <div class="form-group">
                <label for="email" class="form-label required">Email Address</label>
                <input type="email" id="email" name="email" class="form-control" required 
                       placeholder="your.email@example.com">
                <div class="form-text">You'll receive appointment confirmations here</div>
            </div>
        </div>

        <!-- Appointment Details -->
        <div class="form-row">
            <div class="form-group">
                <label for="date" class="form-label required">Preferred Date</label>
                <input type="date" id="date" name="date" class="form-control" required 
                       min="{{ today|date:'Y-m-d' }}">
                <div class="form-text">Choose your preferred appointment date</div>
            </div>

            <div class="form-group">
                <label for="time" class="form-label required">Preferred Time</label>
                <select id="time" name="time" class="form-control" required>
                    <option value="">Select a time</option>
                    <optgroup label="Morning">
                        <option value="08:00">8:00 AM</option>
                        <option value="08:30">8:30 AM</option>
                        <option value="09:00">9:00 AM</option>
                        <option value="09:30">9:30 AM</option>
                        <option value="10:00">10:00 AM</option>
                        <option value="10:30">10:30 AM</option>
                        <option value="11:00">11:00 AM</option>
                        <option value="11:30">11:30 AM</option>
                    </optgroup>
                    <optgroup label="Afternoon">
                        <option value="13:00">1:00 PM</option>
                        <option value="13:30">1:30 PM</option>
                        <option value="14:00">2:00 PM</option>
                        <option value="14:30">2:30 PM</option>
                        <option value="15:00">3:00 PM</option>
                        <option value="15:30">3:30 PM</option>
                        <option value="16:00">4:00 PM</option>
                        <option value="16:30">4:30 PM</option>
                    </optgroup>
                </select>
                <div class="form-text">Select your preferred time slot</div>
            </div>
        </div>

        <!-- Additional Information -->
        <div class="form-row single">
            <div class="form-group">
                <label for="message" class="form-label">Additional Notes</label>
                <textarea id="message" name="message" class="form-control" 
                          placeholder="Please describe your concerns, symptoms, or any specific requests..." 
                          maxlength="500"></textarea>
                <div class="form-text">Optional: Provide any additional information that might help us prepare for your visit (max 500 characters)</div>
            </div>
        </div>

        <!-- Submit Section -->
        <div class="submit-section">
            <button type="submit" class="btn btn-primary btn-lg">
                <i class="fas fa-calendar-check" aria-hidden="true"></i>
                Book Appointment
            </button>
            <p style="margin-top: var(--spacing-md); color: var(--text-muted); font-size: 0.9rem;">
                By booking this appointment, you agree to our terms of service and privacy policy.
            </p>
        </div>
    </form>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    // Set minimum date to today
    const dateInput = document.getElementById('date');
    const today = new Date().toISOString().split('T')[0];
    dateInput.min = today;

    // Form validation
    const form = document.getElementById('bookingForm');
    const inputs = form.querySelectorAll('input, select, textarea');

    inputs.forEach(input => {
        input.addEventListener('blur', validateField);
        input.addEventListener('input', clearError);
    });

    function validateField(e) {
        const field = e.target;
        const value = field.value.trim();
        
        // Remove existing error
        clearError(e);
        
        if (field.hasAttribute('required') && !value) {
            showError(field, 'This field is required');
            return false;
        }

        // Specific validations
        if (field.type === 'email' && value && !isValidEmail(value)) {
            showError(field, 'Please enter a valid email address');
            return false;
        }

        if (field.type === 'tel' && value && !isValidPhone(value)) {
            showError(field, 'Please enter a valid Philippine mobile number');
            return false;
        }

        if (field.name === 'name' && value && !isValidName(value)) {
            showError(field, 'Please enter a valid name (letters only, 2-50 characters)');
            return false;
        }

        return true;
    }

    function clearError(e) {
        const field = e.target;
        field.classList.remove('is-invalid');
        const errorDiv = field.parentNode.querySelector('.invalid-feedback');
        if (errorDiv) {
            errorDiv.remove();
        }
    }

    function showError(field, message) {
        field.classList.add('is-invalid');
        const errorDiv = document.createElement('div');
        errorDiv.className = 'invalid-feedback';
        errorDiv.textContent = message;
        field.parentNode.appendChild(errorDiv);
    }

    function isValidEmail(email) {
        return /^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(email);
    }

    function isValidPhone(phone) {
        return /^(\+63|63|0)?[9]\d{9}$/.test(phone.replace(/\s/g, ''));
    }

    function isValidName(name) {
        return /^[a-zA-Z\s]{2,50}$/.test(name);
    }

    // Form submission
    form.addEventListener('submit', function(e) {
        e.preventDefault();
        
        let isValid = true;
        inputs.forEach(input => {
            if (!validateField({ target: input })) {
                isValid = false;
            }
        });

        if (isValid) {
            showLoading();
            form.submit();
        } else {
            // Scroll to first error
            const firstError = form.querySelector('.is-invalid');
            if (firstError) {
                firstError.scrollIntoView({ behavior: 'smooth', block: 'center' });
                firstError.focus();
            }
        }
    });

    // Character counter for textarea
    const messageTextarea = document.getElementById('message');
    const maxLength = messageTextarea.getAttribute('maxlength');
    
    if (maxLength) {
        const counter = document.createElement('div');
        counter.className = 'form-text';
        counter.style.textAlign = 'right';
        messageTextarea.parentNode.appendChild(counter);
        
        messageTextarea.addEventListener('input', function() {
            const remaining = maxLength - this.value.length;
            counter.textContent = `${remaining} characters remaining`;
            counter.style.color = remaining < 50 ? 'var(--warning)' : 'var(--text-muted)';
        });
        
        // Initial update
        messageTextarea.dispatchEvent(new Event('input'));
    }
});
</script>
{% endblock %}